<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ìº˜ë¦¬ê·¸ë¼í”¼ í•©ì„±ê¸°</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        'sans': ['Jua', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Jua&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Jua', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            height: 100vh;
            height: 100dvh; /* ë™ì  ë·°í¬íŠ¸ ë†’ì´ ì‚¬ìš© (ëª¨ë°”ì¼ ìµœì í™”) */
            max-height: 100vh;
            max-height: 100dvh; /* ë™ì  ë·°í¬íŠ¸ ë†’ì´ ì‚¬ìš© */
            overflow: hidden; /* ìŠ¤í¬ë¡¤ ì™„ì „ ë°©ì§€ */
            margin: 0;
            padding: 0;
            /* ëª¨ë°”ì¼ í„°ì¹˜ ìµœì í™” */
            touch-action: none; /* ëª¨ë“  í„°ì¹˜ ì•¡ì…˜ ë°©ì§€ */
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -khtml-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            /* í„°ì¹˜ ìŠ¤í¬ë¡¤ ë°©ì§€ */
            -webkit-overflow-scrolling: touch;
            overscroll-behavior: none;
        }
        
        /* ëª¨ë°”ì¼ ë·°í¬íŠ¸ ë†’ì´ ë³´ì • */
        @supports (height: 100dvh) {
            body {
                height: 100dvh;
                max-height: 100dvh;
            }
        }
        
        /* iOS Safari ì£¼ì†Œì°½ ê³ ë ¤í•œ ë†’ì´ ê³„ì‚° */
        @media screen and (max-width: 768px) {
            body {
                height: calc(100vh - env(safe-area-inset-top) - env(safe-area-inset-bottom));
                max-height: calc(100vh - env(safe-area-inset-top) - env(safe-area-inset-bottom));
            }
            
            @supports (height: 100dvh) {
                body {
                    height: calc(100dvh - env(safe-area-inset-top) - env(safe-area-inset-bottom));
                    max-height: calc(100dvh - env(safe-area-inset-top) - env(safe-area-inset-bottom));
                }
            }
        }
        
        /* ëª¨ë“  ìš”ì†Œì— Jua í°íŠ¸ ê°•ì œ ì ìš© */
        *, *::before, *::after {
            font-family: 'Jua', sans-serif !important;
        }
        
        .custom-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        
        .custom-modal-content {
            background: white;
            border-radius: 20px;
            padding: 30px;
            max-width: 90vw;
            max-height: 90vh;
            text-align: center;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }
        
        .custom-modal h3 {
            font-size: 1.5rem;
            /* font-weight: bold; */
            margin-bottom: 20px;
            color: #333;
        }
        
        .custom-modal p {
            margin-bottom: 20px;
            color: #666;
        }
        
        .custom-modal button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            margin: 0 10px;
            transition: transform 0.2s;
        }
        
        .custom-modal button:hover {
            transform: translateY(-2px);
        }
        
        .custom-modal button.secondary {
            background: #e5e7eb;
            color: #374151;
        }
        
        .step {
            display: none;
            height: 100vh;
            height: 100dvh; /* ë™ì  ë·°í¬íŠ¸ ë†’ì´ ì‚¬ìš© */
            overflow: hidden; /* ìŠ¤í¬ë¡¤ ë°©ì§€ */
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            z-index: 1;
        }
        
        .step.active {
            display: block;
            height: 100vh;
            height: 100dvh; /* ë™ì  ë·°í¬íŠ¸ ë†’ì´ ì‚¬ìš© */
            overflow: hidden; /* ìŠ¤í¬ë¡¤ ë°©ì§€ */
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            z-index: 1;
        }
        
        /* ëª¨ë°”ì¼ì—ì„œ ìŠ¤í… ë†’ì´ ë³´ì • */
        @media screen and (max-width: 768px) {
            .step, .step.active {
                height: calc(100vh - env(safe-area-inset-top) - env(safe-area-inset-bottom));
            }
            
            @supports (height: 100dvh) {
                .step, .step.active {
                    height: calc(100dvh - env(safe-area-inset-top) - env(safe-area-inset-bottom));
                }
            }
        }
        
        .image-preview {
            max-width: 100%;
            max-height: 60vh;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            margin: 20px auto;
            display: block;
            object-fit: contain;
            object-position: center;
        }
        
        .crop-overlay {
            position: relative;
            display: inline-block;
            border-radius: 10px;
            overflow: hidden;
            max-width: 90vw;
            max-height: 70vh;
        }
        
        .crop-area {
            position: absolute;
            border: 2px solid #667eea;
            background: rgba(102, 126, 234, 0.1);
            cursor: move;
            z-index: 5;
            pointer-events: auto;
            /* ëª¨ë°”ì¼ í„°ì¹˜ ìµœì í™” */
            touch-action: none;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -khtml-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }
        
        .crop-handle {
            position: absolute;
            width: 24px;
            height: 24px;
            background: #667eea;
            border: 3px solid white;
            border-radius: 50%;
            cursor: pointer;
            z-index: 15;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            /* ëª¨ë°”ì¼ í„°ì¹˜ ìµœì í™” */
            touch-action: none;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -khtml-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            /* í•­ìƒ ë³´ì´ë„ë¡ ê°•ì œ */
            opacity: 1 !important;
            visibility: visible !important;
            display: block !important;
        }
        
        .crop-handle:hover {
            background: #5a67d8;
            transform: scale(1.1);
        }
        
        .crop-handle.nw { top: -10px; left: -10px; cursor: nw-resize; }
        .crop-handle.ne { top: -10px; right: -10px; cursor: ne-resize; }
        .crop-handle.sw { bottom: -10px; left: -10px; cursor: sw-resize; }
        .crop-handle.se { bottom: -10px; right: -10px; cursor: se-resize; }
        
        .crop-handle.n { top: -10px; left: 50%; transform: translateX(-50%); cursor: n-resize; }
        .crop-handle.s { bottom: -10px; left: 50%; transform: translateX(-50%); cursor: s-resize; }
        .crop-handle.w { left: -10px; top: 50%; transform: translateY(-50%); cursor: w-resize; }
        .crop-handle.e { right: -10px; top: 50%; transform: translateY(-50%); cursor: e-resize; }
        
        .composite-preview-container {
            display: flex !important;
            justify-content: center !important;
            align-items: center !important;
            width: 100% !important;
            height: calc(100vh - 250px); /* ìœ„/ì•„ë˜ ë²„íŠ¼ ê³µê°„ ì œì™¸í•˜ê³  ìµœëŒ€ ë†’ì´ */
            height: calc(100dvh - 250px); /* ë™ì  ë·°í¬íŠ¸ ë†’ì´ ì‚¬ìš© */
            padding: 10px;
            box-sizing: border-box;
            text-align: center;
            position: static;
            margin-bottom: 20px;
            overflow: hidden; /* ìŠ¤í¬ë¡¤ ë°©ì§€ */
        }
        
        /* ëª¨ë°”ì¼ì—ì„œ ì»´í¬ì§€íŠ¸ í”„ë¦¬ë·° ë†’ì´ ë³´ì • */
        @media screen and (max-width: 768px) {
            .composite-preview-container {
                height: calc(100vh - 500px - env(safe-area-inset-top) - env(safe-area-inset-bottom));
                margin-bottom: 60px; /* í•˜ë‹¨ ì—¬ë°± ë” ì¦ê°€ */
                padding-bottom: 40px;
            }
            
            @supports (height: 100dvh) {
                .composite-preview-container {
                    height: calc(100dvh - 500px - env(safe-area-inset-top) - env(safe-area-inset-bottom));
                }
            }
            
            /* ëª¨ë“  ë‹¨ê³„ ë²„íŠ¼ ì˜ì—­ ì•ˆì „ ì—¬ë°± */
            .step-1 .text-center.mt-8,
            .step-2 .text-center.mt-6,
            .step-3 .text-center.mt-6 {
                padding-bottom: calc(20px + env(safe-area-inset-bottom));
                margin-bottom: 20px;
            }
            
            /* ëª¨ë“  ë‹¨ê³„ ë²„íŠ¼ */
            .step-1 button,
            .step-2 button,
            .step-3 button {
                margin-bottom: calc(10px + env(safe-area-inset-bottom));
            }
        }
        
        /* ëª¨ë°”ì¼ ë²„íŠ¼ ì˜ì—­ ì•ˆì „ ì—¬ë°± */
        @media screen and (max-width: 768px) {
            /* ì²« í˜ì´ì§€ ì»¨í…Œì´ë„ˆ ì•ˆì „ ì—¬ë°± */
            .step-1 .container {
                padding-bottom: calc(20px + env(safe-area-inset-bottom));
            }
            
            .flex.justify-center.space-x-4 {
                padding-bottom: calc(20px + env(safe-area-inset-bottom));
                margin-bottom: 20px;
            }
            
            /* ë‹¤ìš´ë¡œë“œ ë²„íŠ¼ íŠ¹ë³„ ì²˜ë¦¬ */
            #downloadBtn {
                margin-bottom: calc(10px + env(safe-area-inset-bottom));
            }
            
            /* ì „ì²´ ë²„íŠ¼ ì»¨í…Œì´ë„ˆì— ì•ˆì „ ì—¬ë°± */
            .step-4 .flex.justify-center.space-x-4 {
                position: relative;
                z-index: 10;
                background: rgba(102, 126, 234, 0.1);
                backdrop-filter: blur(10px);
                border-radius: 20px 20px 0 0;
                padding: 20px;
                padding-bottom: calc(20px + env(safe-area-inset-bottom));
            }
        }
        
        .composite-preview {
            position: relative;
            display: block;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            background: transparent;
            margin: 0 auto !important;
            max-width: 100%;
            max-height: 100%;
            width: auto;
            height: auto;
            text-align: center;
            aspect-ratio: auto;
        }
        
        /* 770px ì´ìƒì—ì„œ ì»¨í…Œì´ë„ˆ í¬ê¸° ê³ ì • */
        @media (min-width: 770px) {
            .composite-preview-container {
                height: calc(100vh - 200px); /* ìœ„/ì•„ë˜ ë²„íŠ¼ ê³µê°„ ì œì™¸í•˜ê³  ìµœëŒ€ ë†’ì´ */
                padding: 20px;
                width: 100% !important;
            }
            
            .composite-preview {
                max-width: 100%;
                max-height: 100%;
                width: 100%;
                height: 100%;
            }
        }
        
        /* 1200px ì´ìƒì—ì„œ ë” í° ì»¨í…Œì´ë„ˆ */
        @media (min-width: 1200px) {
            .composite-preview-container {
                height: calc(100vh - 250px); /* ìœ„/ì•„ë˜ ë²„íŠ¼ ê³µê°„ ì œì™¸í•˜ê³  ìµœëŒ€ ë†’ì´ */
                padding: 30px;
            }
            
            .composite-preview {
                max-width: 100%;
                max-height: 100%;
                width: 100%;
                height: 100%;
            }
        }
        
        /* 480px ì´í•˜ì—ì„œ ëª¨ë°”ì¼ ìµœì í™” */
        @media (max-width: 480px) {
            .composite-preview-container {
                height: calc(100vh - 250px); /* ìœ„/ì•„ë˜ ë²„íŠ¼ ê³µê°„ ì œì™¸í•˜ê³  ìµœëŒ€ ë†’ì´ */
                padding: 5px;
                overflow: hidden; /* ìŠ¤í¬ë¡¤ ë°©ì§€ */
            }
            
            .composite-preview {
                max-width: 100%;
                max-height: 100%;
                width: 100%;
                height: 100%;
            }

            /* ëª¨ë°”ì¼ì—ì„œ í•¸ë“¤ í¬ê¸° ì¦ê°€ */
            .edit-handle {
                width: 50px !important;
                height: 50px !important;
                min-width: 50px !important;
                min-height: 50px !important;
                max-width: 50px !important;
                max-height: 50px !important;
                font-size: 20px;
            }

            .crop-handle {
                width: 36px;
                height: 36px;
                border: 4px solid white;
                box-shadow: 0 3px 12px rgba(0,0,0,0.4);
            }

            /* ëª¨ë°”ì¼ì—ì„œ ì»¨í…Œì´ë„ˆ ë†’ì´ ì¡°ì • */
            .container {
                height: 100vh;
                overflow: hidden;
            }

            .control-panel {
                max-height: calc(100vh - 100px);
                overflow: hidden;
            }
        }
        
        .composite-preview .background-image {
            width: 100%;
            height: 100%;
            display: block;
            object-fit: contain;
            object-position: center;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }
        
        /* ë°°ê²½ ì´ë¯¸ì§€ê°€ ì»¨í…Œì´ë„ˆì— ë§ê²Œ ì „ì²´ê°€ ë³´ì´ë„ë¡ ì¡°ì • */
        .composite-preview {
            width: 100%;
            height: 100%;
            max-width: 100%;
            max-height: 100%;
            position: relative;
            overflow: hidden;
        }
        
        .composite-preview .calligraphy-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: auto;
            cursor: move;
            background: transparent;
            /* ëª¨ë°”ì¼ í„°ì¹˜ ìµœì í™” */
            touch-action: none;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -khtml-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }
        
        .composite-preview .calligraphy-overlay img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }
        
        /* calligraphyOverlay ë‚´ë¶€ì˜ í¸ì§‘ í•¸ë“¤ ìŠ¤íƒ€ì¼ */
        .calligraphy-overlay .edit-handles {
            position: absolute !important;
            pointer-events: auto !important;
            z-index: 10 !important;
            opacity: 1 !important;
            visibility: visible !important;
            display: block !important;
            margin: 0 !important;
            padding: 0 !important;
            box-sizing: border-box !important;
        }
        
        .calligraphy-overlay .edit-handles::before {
            border: 3px solid #667eea !important;
            background: transparent !important;
            margin: 0 !important;
            padding: 0 !important;
            box-sizing: border-box !important;
        }
        
        .calligraphy-overlay .edit-handle {
            opacity: 1 !important;
            visibility: visible !important;
            display: flex !important;
            position: absolute !important;
        }
        
        .edit-handles {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: auto !important;
            box-sizing: border-box;
            z-index: 10;
            overflow: visible;
            display: block !important;
            opacity: 1 !important;
            visibility: visible !important;
            /* ê¸€ì”¨ ì´ë¯¸ì§€ì™€ ì™„ì „ ë™ê¸°í™”ë¥¼ ìœ„í•œ ì„¤ì • */
            transform-origin: center;
            will-change: transform, left, top, width, height;
        }
        
        .edit-handles::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border: 3px solid #667eea; /* í…Œë‘ë¦¬ë¥¼ ë” êµµê²Œ */
            background: transparent; /* ë°°ê²½ìƒ‰ ì œê±° */
            pointer-events: none;
            box-sizing: border-box;
        }
        
        /* í¸ì§‘ í•¸ë“¤ì´ calligraphy-overlayì™€ ë™ì¼í•œ transformì„ ê°€ì§€ë„ë¡ */
        .edit-handles {
            transform-origin: center;
        }
        
        .crop-outline {
            position: absolute;
            border: 2px solid #667eea;
            /* background: rgba(102, 126, 234, 0.1); */
            pointer-events: none;
            box-sizing: border-box;
            z-index: 5;
        }
        
        .edit-handle {
            position: absolute;
            width: 40px !important;
            height: 40px !important;
            background: #667eea;
            border: 3px solid #ffffff;
            border-radius: 50%;
            cursor: pointer;
            pointer-events: auto;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            font-weight: bold;
            color: #ffffff;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
            box-shadow: 0 4px 8px rgba(0,0,0,0.6);
            transition: all 0.2s ease;
            mix-blend-mode: normal !important;
            filter: none !important;
            transform: none !important;
            min-width: 40px !important;
            min-height: 40px !important;
            max-width: 40px !important;
            max-height: 40px !important;
            opacity: 1 !important; /* í•­ìƒ ë³´ì´ë„ë¡ ê°•ì œ */
            visibility: visible !important; /* í•­ìƒ ë³´ì´ë„ë¡ ê°•ì œ */
            /* ëª¨ë°”ì¼ í„°ì¹˜ ìµœì í™” */
            touch-action: none;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -khtml-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }
        
        .edit-handle:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 12px rgba(0,0,0,0.8);
            background: #333333;
        }
        
        .edit-handle.scale {
            bottom: -20px;
            right: -20px;
            cursor: se-resize;
        }
        
        .edit-handle.rotate {
            top: -20px;
            right: -20px;
            cursor: grab;
        }
        
        .edit-handle.rotate:active {
            cursor: grabbing;
        }
        
        /* ì•„ì´ì½˜ì´ ë¶€ëª¨ì˜ ìŠ¤ì¼€ì¼ ë³€í™˜ì— ì˜í–¥ë°›ì§€ ì•Šë„ë¡ */
        .calligraphy-overlay {
            transform-origin: center;
        }
        
        .edit-handles {
            transform-origin: center;
        }
        
        .edit-handle {
            transform-origin: center !important;
        }
        
        .control-panel {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }
        
        .control-group {
            margin-bottom: 20px;
        }
        
        .control-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #374151;
        }
        
        .control-group input[type="range"] {
            width: 100%;
            margin: 10px 0;
        }
        
        .control-group input[type="color"] {
            width: 50px;
            height: 50px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
        }
        
        .blend-mode-buttons {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        
        .blend-mode-buttons button {
            padding: 12px 32px;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 1rem;
            font-weight: bold;
            margin: 0 10px;
        }
        
        .blend-mode-buttons button.active {
            transform: translateY(-2px);
        }
        
        .blend-mode-buttons button#multiplyMode.active {
            background: white;
            color: black;
        }
        
        .blend-mode-buttons button#screenMode {
            background: black;
            color: white;
        }
        
        .blend-mode-buttons button#screenMode.active {
            background: black;
            color: white;
        }
        
        .file-upload-area {
            border: 2px dashed #cbd5e1;
            border-radius: 15px;
            padding: 40px 20px;
            text-align: center;
            background: #f8fafc;
            transition: all 0.3s;
            cursor: pointer;
        }
        
        .file-upload-area:hover {
            border-color: #667eea;
            background: #f1f5f9;
        }
        
        .file-upload-area.dragover {
            border-color: #667eea;
            background: #e0e7ff;
        }
        
        .back-button {
            position: fixed;
            top: 20px;
            left: 20px;
            background: rgba(255, 255, 255, 0.9);
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            font-size: 1.5rem;
            cursor: pointer;
            z-index: 100;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            transition: all 0.2s;
        }
        
        .back-button:hover {
            background: white;
            transform: scale(1.1);
        }
        
        .progress-bar {
            width: 100%;
            height: 6px;
            background: #e5e7eb;
            border-radius: 3px;
            overflow: hidden;
            margin: 20px 0;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            width: 0%;
            transition: width 0.3s ease;
        }
        
        .step-indicator {
            display: flex;
            justify-content: center;
            margin-top: 30px;
            margin-bottom: 0;
        }
        
        .step-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.5);
            margin: 0 8px;
            transition: all 0.3s;
        }
        
        .step-dot.active {
            background: #ffffff;
            transform: scale(1.2);
        }
        
        .step-dot.completed {
            background: rgba(255, 255, 255, 0.5);
        }
        
        #menu-hamburger:hover {
          background: rgba(255,255,255,0.18) !important;
        }
    </style>
</head>
<body>
    <!-- í–„ë²„ê±° ë©”ë‰´ ë²„íŠ¼ ë° ë©”ë‰´ -->
    <div id="menu-hamburger" style="position:fixed;top:24px;right:28px;z-index:9999;cursor:pointer;width:44px;height:44px;display:flex;align-items:center;justify-content:center;background:transparent;border-radius:50%;transition:background 0.18s;">
      <div style="width:26px;height:20px;display:flex;flex-direction:column;justify-content:space-between;">
        <span class="menu-bar" style="display:block;height:4px;width:100%;background:#fff;border-radius:2px;"></span>
        <span class="menu-bar" style="display:block;height:4px;width:100%;background:#fff;border-radius:2px;"></span>
        <span class="menu-bar" style="display:block;height:4px;width:100%;background:#fff;border-radius:2px;"></span>
      </div>
    </div>
    <div id="menu-popup" style="display:none;position:fixed;top:70px;right:32px;z-index:10000;background:#fff;border-radius:16px;box-shadow:0 4px 24px #0003;padding:18px 28px 14px 28px;min-width:180px;text-align:left;">
      <div style="font-size:1.08rem;font-weight:bold;color:#667eea;margin-bottom:10px;">ë©”ë‰´</div>
      <div style="margin-bottom:8px;cursor:pointer;color:#444;padding:7px 0;border-radius:8px;transition:background 0.15s;" onclick="location.href='index.html'" onmouseover="this.style.background='#f1f5f9'" onmouseout="this.style.background='none'">ë½€ëª¨ë„ë¡œ íƒ€ì´ë¨¸</div>
      <div style="margin-bottom:8px;cursor:pointer;color:#444;padding:7px 0;border-radius:8px;transition:background 0.15s;" onclick="location.href='infiniteStairs.html'" onmouseover="this.style.background='#f1f5f9'" onmouseout="this.style.background='none'">ë¬´í•œì˜ ê³„ë‹¨</div>
      <div style="margin-bottom:8px;cursor:pointer;color:#444;padding:7px 0;border-radius:8px;transition:background 0.15s;" onclick="location.href='website.html'" onmouseover="this.style.background='#f1f5f9'" onmouseout="this.style.background='none'">ì›¹ì‚¬ì´íŠ¸</div>
      <div style="margin-bottom:8px;cursor:pointer;color:#444;padding:7px 0;border-radius:8px;transition:background 0.15s;" onclick="location.href='habitTracker/index.html'" onmouseover="this.style.background='#f1f5f9'" onmouseout="this.style.background='none'">ìŠµê´€ ì¶”ì ê¸°</div>
      <div style="margin-bottom:8px;cursor:pointer;color:#444;padding:7px 0;border-radius:8px;transition:background 0.15s;" onclick="location.href='survey/index.html'" onmouseover="this.style.background='#f1f5f9'" onmouseout="this.style.background='none'">ì„¤ë¬¸ì¡°ì‚¬</div>
    </div>
    
    <!-- ë’¤ë¡œê°€ê¸° ë²„íŠ¼ -->
    <button class="back-button" onclick="goBack()" style="display: none;">â†</button>
    
    <!-- ë‹¨ê³„ 1: ë°°ê²½ ì´ë¯¸ì§€ ì—…ë¡œë“œ -->
    <div class="step active" id="step1">
        <div class="container mx-auto px-4 py-4">
            <h1 class="text-3xl text-center text-white mb-8">ìº˜ë¦¬ê·¸ë¼í”¼ í•©ì„±ê¸°</h1>
            
            <div class="max-w-2xl mx-auto">
                    <div class="control-panel">
                        <h2 class="text-xl mb-4 text-center">1. ë°°ê²½ ì‚¬ì§„ ì—…ë¡œë“œ</h2>
                        <div class="file-upload-area" id="backgroundUploadArea" onclick="document.getElementById('backgroundInput').click()">
                            <div class="text-6xl mb-4">ğŸ–¼ï¸</div>
                            <p class="text-lg  mb-2">ë°°ê²½ ì‚¬ì§„ì„ ì„ íƒí•˜ì„¸ìš”</p>
                            <p class="text-gray-600">í´ë¦­í•˜ê±°ë‚˜ ë“œë˜ê·¸í•˜ì—¬ ì—…ë¡œë“œ</p>
                            <input type="file" id="backgroundInput" accept="image/*" style="display: none;">
                        </div>
                        <div id="backgroundCheckArea" class="mt-4" style="display: none;">
                            <div class="text-center">
                                <div class="text-6xl mb-4 text-green-500">âœ…</div>
                                <p class="text-lg text-green-600 font-semibold">ë°°ê²½ ì‚¬ì§„ì´ ì—…ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤</p>
                            </div>
                        </div>
                    </div>
                    
                <div class="text-center mt-8" id="nextButtonContainer" style="display: none;">
                    <button id="nextToStep2" class="bg-white text-purple-600 px-8 py-3 rounded-full  text-lg shadow-lg hover:shadow-xl transition-all">
                        ë‹¤ìŒ
                    </button>
                </div>
            </div>
            
            <!-- ë‹¨ê³„ í‘œì‹œê¸° -->
            <div class="step-indicator">
                <div class="step-dot active" data-step="1"></div>
                <div class="step-dot" data-step="2"></div>
                <div class="step-dot" data-step="3"></div>
                <div class="step-dot" data-step="4"></div>
            </div>
        </div>
    </div>
    
    <!-- ë‹¨ê³„ 2: ê¸€ì”¨ ì´ë¯¸ì§€ ì—…ë¡œë“œ -->
    <div class="step" id="step2">
        <div class="container mx-auto px-4 py-4">
            <h1 class="text-3xl text-center text-white mb-8">ê¸€ì”¨ ì‚¬ì§„ ì—…ë¡œë“œ</h1>
            
            <div class="max-w-2xl mx-auto">
                    <div class="control-panel">
                    <h2 class="text-xl mb-4 text-center">2. ê¸€ì”¨ ì‚¬ì§„ ì—…ë¡œë“œ</h2>
                        <div class="file-upload-area" onclick="document.getElementById('calligraphyInput').click()">
                            <div class="text-6xl mb-4">âœï¸</div>
                            <p class="text-lg  mb-2">ê¸€ì”¨ ì‚¬ì§„ì„ ì„ íƒí•˜ì„¸ìš”</p>
                            <p class="text-gray-600">í´ë¦­í•˜ê±°ë‚˜ ë“œë˜ê·¸í•˜ì—¬ ì—…ë¡œë“œ</p>
                            <input type="file" id="calligraphyInput" accept="image/*" style="display: none;">
                        </div>
                  
                </div>
                
            </div>
            
            <!-- ë‹¨ê³„ í‘œì‹œê¸° -->
            <div class="step-indicator">
                <div class="step-dot" data-step="1"></div>
                <div class="step-dot active" data-step="2"></div>
                <div class="step-dot" data-step="3"></div>
                <div class="step-dot" data-step="4"></div>
            </div>
        </div>
    </div>
    
    <!-- ë‹¨ê³„ 3: ê¸€ì”¨ ì‚¬ì§„ ë³´ì • ë° ìë¥´ê¸° -->
    <div class="step" id="step3">
        <div class="container mx-auto px-4 py-4">
            <h1 class="text-3xl  text-center text-white mb-8">ê¸€ì”¨ ë¶€ë¶„ ìë¥´ê¸°</h1>
            
            <div class="max-w-7xl mx-auto">
                <div class="control-panel">
                    
                    <div class="text-center">
                        <div class="crop-overlay" id="cropContainer">
                            <img id="processedCalligraphy" class="image-preview" alt="ë³´ì •ëœ ê¸€ì”¨">
                            <div class="crop-area" id="cropArea"></div>
                        </div>
                        
                    </div>
                    
                    <div class="text-center mt-6">
                        <button id="nextToStep4" class="bg-purple-500 text-white px-8 py-3 rounded-full  text-lg shadow-lg hover:shadow-xl transition-all">
                            ìë¥´ê¸° ì™„ë£Œ
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- ë‹¨ê³„ í‘œì‹œê¸° -->
            <div class="step-indicator">
                <div class="step-dot" data-step="1"></div>
                <div class="step-dot" data-step="2"></div>
                <div class="step-dot active" data-step="3"></div>
                <div class="step-dot" data-step="4"></div>
            </div>
        </div>
    </div>
    
    <!-- ë‹¨ê³„ 4: ì‚¬ì§„ í•©ì„± ë° í¸ì§‘ -->
    <div class="step" id="step4">
        <div class="container mx-auto px-4 py-4">
                        
            <div class="max-w-6xl mx-auto">
                <div class="grid md:grid-cols-2 gap-8">
                    <!-- ë¯¸ë¦¬ë³´ê¸° ì˜ì—­ -->
                    <div class="control-panel">
                        <div class="control-group mt-4">
                            <div class="blend-mode-buttons justify-center">
                                <button id="multiplyMode" class="active bg-white text-black px-8 py-3 rounded-full text-base shadow-lg hover:shadow-xl transition-all">ê²€ì€ ê¸€ì”¨</button>
                                <button id="screenMode" class="bg-black text-white px-8 py-3 rounded-full text-base shadow-lg hover:shadow-xl transition-all">í° ê¸€ì”¨</button>
                            </div>
                        </div>
                        <div class="composite-preview-container">
                            <div class="composite-preview" id="compositePreview">
                                <img id="compositeBackground" class="background-image" alt="í•©ì„± ë¯¸ë¦¬ë³´ê¸°">
                                <div class="calligraphy-overlay" id="calligraphyOverlay">
                                    <img id="compositeCalligraphy" alt="ê¸€ì”¨ ì˜¤ë²„ë ˆì´">
                                    <div class="edit-handles" id="editHandles">
                                        <div class="edit-handle scale" id="scaleHandle">â†˜</div>
                                        <div class="edit-handle rotate" id="rotateHandle">â†»</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- ìƒ‰ìƒ ë° ë¸”ë Œë“œ ëª¨ë“œ -->
                        
                        
                        <div class="text-center mt-6 space-x-4">
                            <button id="restartBtn" class="bg-gray-500 text-white px-8 py-3 rounded-full  text-base shadow-lg hover:shadow-xl transition-all">
                                ë‹¤ì‹œ ì‹œì‘
                            </button>
                            <button id="downloadBtn" class="bg-purple-500 text-white px-8 py-3 rounded-full  text-base shadow-lg hover:shadow-xl transition-all">
                                ë‹¤ìš´ë¡œë“œ
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- ë‹¨ê³„ í‘œì‹œê¸° -->
            <div class="step-indicator">
                <div class="step-dot" data-step="1"></div>
                <div class="step-dot" data-step="2"></div>
                <div class="step-dot" data-step="3"></div>
                <div class="step-dot active" data-step="4"></div>
            </div>
        </div>
    </div>
    
    
    <!-- ì»¤ìŠ¤í…€ ëª¨ë‹¬ -->
    <div class="custom-modal" id="customModal">
        <div class="custom-modal-content">
            <h3 id="modalTitle">ì•Œë¦¼</h3>
            <p id="modalMessage">ë©”ì‹œì§€ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</p>
            <div>
                <button id="modalConfirm" onclick="closeModal()">í™•ì¸</button>
                <button id="modalCancel" onclick="closeModal()" class="secondary" style="display: none;">ì·¨ì†Œ</button>
            </div>
        </div>
    </div>

    <script>
        // ì „ì—­ ë³€ìˆ˜
        let backgroundImage = null;
        let calligraphyImage = null;
        let processedCalligraphy = null;
        let croppedCalligraphy = null;
        let currentStep = 1;
        let isDragging = false;
        let dragStart = { x: 0, y: 0 };
        let currentPosition = { x: 50, y: 50 }; // í¼ì„¼íŠ¸
        let currentScale = 0.3; // ë°°ê²½ì˜ 30% í¬ê¸°ë¡œ ì‹œì‘ (ë” ì‘ê²Œ)
        let currentRotation = 0;
        let currentBlendMode = 'multiply';
        // cropAreaëŠ” ì´ì œ cropSystem.cropAreaë¡œ ê´€ë¦¬ë¨
        
        // DOM ìš”ì†Œ
        const steps = document.querySelectorAll('.step');
        const stepDots = document.querySelectorAll('.step-dot');
        const backgroundInput = document.getElementById('backgroundInput');
        const calligraphyInput = document.getElementById('calligraphyInput');
        const backgroundPreview = document.getElementById('backgroundPreview');
        const calligraphyPreview = document.getElementById('calligraphyPreview');
        const backgroundImageEl = document.getElementById('backgroundImage');
        const calligraphyImageEl = document.getElementById('calligraphyImage');
        const processedCalligraphyEl = document.getElementById('processedCalligraphy');
        const cropContainer = document.getElementById('cropContainer');
        const compositePreview = document.getElementById('compositePreview');
        const compositeBackground = document.getElementById('compositeBackground');
        const compositeCalligraphy = document.getElementById('compositeCalligraphy');
        const calligraphyOverlay = document.getElementById('calligraphyOverlay');
        const scaleSlider = document.getElementById('scaleSlider');
        const rotationSlider = document.getElementById('rotationSlider');
        const scaleValue = document.getElementById('scaleValue');
        const rotationValue = document.getElementById('rotationValue');
        const multiplyMode = document.getElementById('multiplyMode');
        const screenMode = document.getElementById('screenMode');
        const customModal = document.getElementById('customModal');
        const modalTitle = document.getElementById('modalTitle');
        const modalMessage = document.getElementById('modalMessage');
        const modalConfirm = document.getElementById('modalConfirm');
        const modalCancel = document.getElementById('modalCancel');
        
        // ì´ë¯¸ì§€ ì••ì¶• í•¨ìˆ˜
        function compressImage(file, maxWidth = 1200, quality = 0.8) {
            return new Promise((resolve) => {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                const img = new Image();
                
                img.onload = () => {
                    const ratio = Math.min(maxWidth / img.width, maxWidth / img.height);
                    canvas.width = img.width * ratio;
                    canvas.height = img.height * ratio;
                    
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                    
                    canvas.toBlob(resolve, 'image/jpeg', quality);
                };
                
                img.src = URL.createObjectURL(file);
            });
        }
        
        // ì´ë¯¸ì§€ ìë™ ë³´ì • í•¨ìˆ˜ (í‘ë°±, ëŒ€ë¹„ 100%)
        function processCalligraphyImage(imageData) {
            return new Promise((resolve) => {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                const img = new Image();
                
                img.onload = () => {
                    canvas.width = img.width;
                    canvas.height = img.height;
                    
                    // ì›ë³¸ ì´ë¯¸ì§€ ê·¸ë¦¬ê¸°
                    ctx.drawImage(img, 0, 0);
                    
                    // ì´ë¯¸ì§€ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
                    const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                    const data = imageData.data;
                    
                    // í‘ë°± ë³€í™˜ ë° ëŒ€ë¹„ ì¡°ì •
                    for (let i = 0; i < data.length; i += 4) {
                        // ê·¸ë ˆì´ìŠ¤ì¼€ì¼ ê³„ì‚°
                        const gray = data[i] * 0.299 + data[i + 1] * 0.587 + data[i + 2] * 0.114;
                        
                        // ëŒ€ë¹„ 100% ì ìš© (0 ë˜ëŠ” 255)
                        const contrast = gray > 128 ? 255 : 0;
                        
                        data[i] = contrast;     // R
                        data[i + 1] = contrast; // G
                        data[i + 2] = contrast; // B
                        // data[i + 3]ëŠ” alpha ì±„ë„ì´ë¯€ë¡œ ê·¸ëŒ€ë¡œ ìœ ì§€
                    }
                    
                    // ì²˜ë¦¬ëœ ì´ë¯¸ì§€ ë°ì´í„° ì ìš©
                    ctx.putImageData(imageData, 0, 0);
                    
                    // ê²°ê³¼ë¥¼ Blobìœ¼ë¡œ ë³€í™˜
                    canvas.toBlob(resolve, 'image/png');
                };
                
                img.src = imageData;
            });
        }
        
        // ëª¨ë‹¬ í‘œì‹œ í•¨ìˆ˜
        function showModal(title, message, showCancel = false) {
            modalTitle.textContent = title;
            modalMessage.textContent = message;
            modalCancel.style.display = showCancel ? 'inline-block' : 'none';
            customModal.style.display = 'flex';
        }
        
        // ëª¨ë‹¬ ë‹«ê¸° í•¨ìˆ˜
        function closeModal() {
            customModal.style.display = 'none';
        }
        
        // ë’¤ë¡œê°€ê¸° í•¨ìˆ˜
        function goBack() {
            if (currentStep > 1) {
                currentStep--;
                showStep(currentStep);
                
                // 2ë‹¨ê³„ì—ì„œ 1ë‹¨ê³„ë¡œ ê°ˆ ë•Œ ì—…ë¡œë“œ ì˜ì—­ ë‹¤ì‹œ í‘œì‹œ
                if (currentStep === 1) {
                    const uploadAreas = document.querySelectorAll('.file-upload-area');
                    uploadAreas.forEach(area => {
                        area.style.display = 'block';
                    });
                    const previews = document.querySelectorAll('#backgroundPreview, #calligraphyPreview');
                    previews.forEach(preview => {
                        preview.style.display = 'none';
                    });
                }
            }
        }
        
        // ë‹¨ê³„ í‘œì‹œ í•¨ìˆ˜
        function showStep(step) {
            steps.forEach((s, index) => {
                s.classList.toggle('active', index + 1 === step);
            });
            
            // ëª¨ë“  ë‹¨ê³„ì˜ ì ë“¤ ì—…ë°ì´íŠ¸
            document.querySelectorAll('.step-indicator').forEach(stepIndicator => {
                const dots = stepIndicator.querySelectorAll('.step-dot');
                dots.forEach((dot, index) => {
                    // ëª¨ë“  í´ë˜ìŠ¤ ì œê±°
                    dot.classList.remove('active', 'completed');
                    
                    // í˜„ì¬ ë‹¨ê³„ë§Œ active (í°ìƒ‰), ë‚˜ë¨¸ì§€ëŠ” ê¸°ë³¸ ìƒíƒœ (í°ìƒ‰ íˆ¬ëª…ë„ 50%)
                    if (index + 1 === step) {
                        dot.classList.add('active');
                    }
                });
            });
            
            // ë’¤ë¡œê°€ê¸° ë²„íŠ¼ í‘œì‹œ/ìˆ¨ê¹€
            document.querySelector('.back-button').style.display = step > 1 ? 'block' : 'none';
            
            // ê° ë‹¨ê³„ë³„ ì´ˆê¸°í™”
            if (step === 3) {
                // í¬ë¡­ ì˜ì—­ ì´ˆê¸°í™”
                setTimeout(() => {
                    initCropArea();
                }, 100);
            } else if (step === 4) {
                updateCompositePreview();
            }
        }
        
        // ë‹¤ìŒ ë‹¨ê³„ë¡œ ì´ë™
        function nextStep() {
            if (currentStep < 4) {
                currentStep++;
                showStep(currentStep);
            }
        }
        
        // ì´ì „ ë‹¨ê³„ë¡œ ì´ë™
        function prevStep() {
            if (currentStep > 1) {
                currentStep--;
                showStep(currentStep);
            }
        }
        
        // ìƒˆë¡œìš´ ì •í™•í•œ ì´ë¯¸ì§€ í¬ë¡­ ì‹œìŠ¤í…œ
        class PreciseCropSystem {
            constructor() {
                this.cropArea = { x: 10, y: 10, width: 80, height: 80 };
                this.isDragging = false;
                this.isResizing = false;
                this.resizeHandle = null;
                this.startPos = { x: 0, y: 0 };
                this.startCropArea = { x: 0, y: 0, width: 0, height: 0 };
            }

            // ì´ë¯¸ì§€ì˜ ì‹¤ì œ í‘œì‹œ ì˜ì—­ ê³„ì‚° (CSS object-fit: contain ê³ ë ¤)
            getImageDisplayBounds(imgElement) {
                const imgRect = imgElement.getBoundingClientRect();
                
                // CSS object-fit: containìœ¼ë¡œ ì¸í•œ ì‹¤ì œ ì´ë¯¸ì§€ ì˜ì—­ ê³„ì‚°
                const imgAspectRatio = imgElement.naturalWidth / imgElement.naturalHeight;
                const containerAspectRatio = imgRect.width / imgRect.height;
                
                let actualWidth, actualHeight, offsetX, offsetY;
                
                if (containerAspectRatio > imgAspectRatio) {
                    // ì»¨í…Œì´ë„ˆê°€ ë” ë„“ìŒ - ì´ë¯¸ì§€ê°€ ì„¸ë¡œë¡œ ë§ì¶°ì§
                    actualHeight = imgRect.height;
                    actualWidth = imgRect.height * imgAspectRatio;
                    offsetX = (imgRect.width - actualWidth) / 2;
                    offsetY = 0;
                } else {
                    // ì»¨í…Œì´ë„ˆê°€ ë” ë†’ìŒ - ì´ë¯¸ì§€ê°€ ê°€ë¡œë¡œ ë§ì¶°ì§
                    actualWidth = imgRect.width;
                    actualHeight = imgRect.width / imgAspectRatio;
                    offsetX = 0;
                    offsetY = (imgRect.height - actualHeight) / 2;
                }
                
                const bounds = {
                    x: imgRect.left + offsetX,
                    y: imgRect.top + offsetY,
                    width: actualWidth,
                    height: actualHeight,
                    offsetX,
                    offsetY,
                    // ì¶”ê°€ ì •ë³´: ì›ë³¸ ì´ë¯¸ì§€ í¬ê¸°ì™€ ì»¨í…Œì´ë„ˆ í¬ê¸°
                    originalWidth: imgElement.naturalWidth,
                    originalHeight: imgElement.naturalHeight,
                    containerWidth: imgRect.width,
                    containerHeight: imgRect.height,
                    aspectRatio: imgAspectRatio,
                    containerAspectRatio: containerAspectRatio
                };
                
                console.log('ì´ë¯¸ì§€ í‘œì‹œ ì˜ì—­ (ê°œì„ ë¨):', bounds);
                return bounds;
            }

            // í”½ì…€ ì¢Œí‘œë¥¼ ì›ë³¸ ì´ë¯¸ì§€ ì¢Œí‘œë¡œ ë³€í™˜
            pixelToImageCoords(pixelX, pixelY, imgElement, displayBounds) {
                const scaleX = imgElement.naturalWidth / displayBounds.width;
                const scaleY = imgElement.naturalHeight / displayBounds.height;
                
                const imageX = (pixelX - displayBounds.x) * scaleX;
                const imageY = (pixelY - displayBounds.y) * scaleY;
                
                return { x: imageX, y: imageY };
            }

            // ì›ë³¸ ì´ë¯¸ì§€ ì¢Œí‘œë¥¼ í”½ì…€ ì¢Œí‘œë¡œ ë³€í™˜
            imageToPixelCoords(imageX, imageY, imgElement, displayBounds) {
                const scaleX = displayBounds.width / imgElement.naturalWidth;
                const scaleY = displayBounds.height / imgElement.naturalHeight;
                
                const pixelX = displayBounds.x + imageX * scaleX;
                const pixelY = displayBounds.y + imageY * scaleY;
                
                return { x: pixelX, y: pixelY };
            }

            // ì •í™•í•œ ì´ë¯¸ì§€ í¬ë¡­
            async cropImage(imageData, cropArea) {
                return new Promise((resolve) => {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    const img = new Image();
                    
                    img.onload = () => {
                        const displayImg = document.getElementById('processedCalligraphy');
                        const displayBounds = this.getImageDisplayBounds(displayImg);
                        
                        // í¬ë¡­ ì˜ì—­ì„ í”½ì…€ ì¢Œí‘œë¡œ ë³€í™˜
                        const cropX = (cropArea.x / 100) * displayBounds.width;
                        const cropY = (cropArea.y / 100) * displayBounds.height;
                        const cropWidth = (cropArea.width / 100) * displayBounds.width;
                        const cropHeight = (cropArea.height / 100) * displayBounds.height;
                        
                        // ì›ë³¸ ì´ë¯¸ì§€ ì¢Œí‘œë¡œ ë³€í™˜
                        const sourceCoords = this.pixelToImageCoords(
                            displayBounds.x + cropX, 
                            displayBounds.y + cropY, 
                            img, 
                            displayBounds
                        );
                        
                        const sourceEndCoords = this.pixelToImageCoords(
                            displayBounds.x + cropX + cropWidth, 
                            displayBounds.y + cropY + cropHeight, 
                            img, 
                            displayBounds
                        );
                        
                        const sourceX = Math.max(0, Math.min(img.naturalWidth, sourceCoords.x));
                        const sourceY = Math.max(0, Math.min(img.naturalHeight, sourceCoords.y));
                        const sourceWidth = Math.max(1, Math.min(img.naturalWidth - sourceX, sourceEndCoords.x - sourceX));
                        const sourceHeight = Math.max(1, Math.min(img.naturalHeight - sourceY, sourceEndCoords.y - sourceY));
                        
                        // í¬ë¡­ëœ ì´ë¯¸ì§€ í¬ê¸° ì„¤ì •
                        canvas.width = sourceWidth;
                        canvas.height = sourceHeight;
                        
                        // ì´ë¯¸ì§€ í¬ë¡­
                        ctx.drawImage(
                            img,
                            sourceX, sourceY, sourceWidth, sourceHeight,
                            0, 0, sourceWidth, sourceHeight
                        );
                        
                        console.log('ì •í™•í•œ í¬ë¡­ ì •ë³´:', {
                            cropArea,
                            displayBounds,
                            sourceCoords: { x: sourceX, y: sourceY, width: sourceWidth, height: sourceHeight },
                            originalSize: { width: img.naturalWidth, height: img.naturalHeight }
                        });
                        
                        canvas.toBlob(resolve, 'image/png');
                    };
                    
                    img.src = imageData;
                });
            }

            // í¬ë¡­ í•¸ë“¤ ì—…ë°ì´íŠ¸
            updateCropHandles(cropAreaEl = null) {
                const img = document.getElementById('processedCalligraphy');
                if (!cropAreaEl) {
                    cropAreaEl = document.getElementById('cropArea');
                }
                
                if (!img || !cropAreaEl) {
                    console.log('ì´ë¯¸ì§€ ë˜ëŠ” í¬ë¡­ ì˜ì—­ ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ');
                    return;
                }
                
                const displayBounds = this.getImageDisplayBounds(img);
                
                // í¬ë¡­ ì˜ì—­ì„ ì´ë¯¸ì§€ ì»¨í…Œì´ë„ˆ ê¸°ì¤€ ìƒëŒ€ ì¢Œí‘œë¡œ ë³€í™˜
                const imgContainer = img.parentElement;
                const containerRect = imgContainer.getBoundingClientRect();
                
                // ì´ë¯¸ì§€ ì»¨í…Œì´ë„ˆ ë‚´ì—ì„œì˜ ìƒëŒ€ ìœ„ì¹˜ ê³„ì‚° (ì´ë¯¸ì§€ì˜ ì‹¤ì œ í‘œì‹œ ì˜ì—­ ê¸°ì¤€)
                const imageOffsetX = displayBounds.x - containerRect.left;
                const imageOffsetY = displayBounds.y - containerRect.top;
                
                const relativeX = imageOffsetX + (this.cropArea.x / 100) * displayBounds.width;
                const relativeY = imageOffsetY + (this.cropArea.y / 100) * displayBounds.height;
                const width = (this.cropArea.width / 100) * displayBounds.width;
                const height = (this.cropArea.height / 100) * displayBounds.height;
                
                console.log('í¬ë¡­ ì˜ì—­ ì—…ë°ì´íŠ¸:', {
                    cropArea: this.cropArea,
                    relativeCoords: { x: relativeX, y: relativeY, width, height },
                    displayBounds,
                    containerRect,
                    imageOffset: { x: imageOffsetX, y: imageOffsetY }
                });
                
                // í¬ë¡­ ì˜ì—­ì´ ì˜¬ë°”ë¥¸ ìœ„ì¹˜ì— ìˆëŠ”ì§€ í™•ì¸
                console.log('í¬ë¡­ ì˜ì—­ ìš”ì†Œ:', cropAreaEl);
                console.log('í¬ë¡­ ì˜ì—­ ìŠ¤íƒ€ì¼:', {
                    left: cropAreaEl.style.left,
                    top: cropAreaEl.style.top,
                    width: cropAreaEl.style.width,
                    height: cropAreaEl.style.height
                });
                
                // í¬ë¡­ ì˜ì—­ ì—…ë°ì´íŠ¸ (ìƒëŒ€ ì¢Œí‘œ ì‚¬ìš©)
                cropAreaEl.style.left = relativeX + 'px';
                cropAreaEl.style.top = relativeY + 'px';
                cropAreaEl.style.width = width + 'px';
                cropAreaEl.style.height = height + 'px';
                
                // í•¸ë“¤ ìœ„ì¹˜ ì—…ë°ì´íŠ¸ (ê¸°ì¡´ í•¸ë“¤ ì™„ì „ ì œê±° í›„ ìƒˆë¡œ ìƒì„±)
                this.updateHandles(cropAreaEl);
            }

            // í•¸ë“¤ ìœ„ì¹˜ ì—…ë°ì´íŠ¸ (í¬ë¡­ ì‚¬ê°í˜•ì— ì •í™•íˆ ë¶™ì´ê¸°)
            updateHandles(cropAreaEl) {
                console.log('í•¸ë“¤ ì—…ë°ì´íŠ¸ ì‹œì‘ - ê¸°ì¡´ í•¸ë“¤ ì œê±°');
                
                // ê¸°ì¡´ í•¸ë“¤ ì™„ì „ ì œê±°
                const existingHandles = cropAreaEl.querySelectorAll('.crop-handle');
                console.log(`ì œê±°í•  í•¸ë“¤ ê°œìˆ˜: ${existingHandles.length}`);
                existingHandles.forEach(handle => {
                    handle.remove();
                });
                
                // ì¦‰ì‹œ í•¸ë“¤ ìƒì„± (ë””ë°”ìš´ì‹± ì—†ì´)
                console.log('ìƒˆ í•¸ë“¤ ìƒì„± ì‹œì‘');
                
                // 8ê°œ í•¸ë“¤ ë™ì  ìƒì„±
                const directions = ['nw', 'ne', 'sw', 'se', 'n', 's', 'w', 'e'];
                directions.forEach(direction => {
                    const handle = document.createElement('div');
                    handle.className = `crop-handle ${direction}`;
                    handle.dataset.direction = direction;
                    cropAreaEl.appendChild(handle);
                });
                
                console.log('ìƒˆ í•¸ë“¤ ìƒì„± ì™„ë£Œ');
                
                // ìƒˆë¡œ ìƒì„±ëœ í•¸ë“¤ì— ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
                const newHandles = cropAreaEl.querySelectorAll('.crop-handle');
                this.setupHandleEvents(newHandles);
                
                // ìƒˆë¡œ ìƒì„±ëœ í•¸ë“¤ ìœ„ì¹˜ ì„¤ì •
                console.log(`ìƒˆë¡œ ìƒì„±ëœ í•¸ë“¤ ê°œìˆ˜: ${newHandles.length}`);
                newHandles.forEach(handle => {
                        const direction = handle.dataset.direction;
                        
                        // ëª¨ë“  í•¸ë“¤ì˜ ê¸°ë³¸ ìŠ¤íƒ€ì¼ ì´ˆê¸°í™”
                        handle.style.left = 'auto';
                        handle.style.right = 'auto';
                        handle.style.top = 'auto';
                        handle.style.bottom = 'auto';
                        handle.style.transform = 'none';
                        
                        switch(direction) {
                            case 'nw':
                                handle.style.left = '-10px';
                                handle.style.top = '-10px';
                                break;
                            case 'ne':
                                handle.style.right = '-10px';
                                handle.style.top = '-10px';
                                break;
                            case 'sw':
                                handle.style.left = '-10px';
                                handle.style.bottom = '-10px';
                                break;
                            case 'se':
                                handle.style.right = '-10px';
                                handle.style.bottom = '-10px';
                                break;
                            case 'n':
                                handle.style.left = '50%';
                                handle.style.top = '-10px';
                                handle.style.transform = 'translateX(-50%)';
                                break;
                            case 's':
                                handle.style.left = '50%';
                                handle.style.bottom = '-10px';
                                handle.style.transform = 'translateX(-50%)';
                                break;
                            case 'w':
                                handle.style.left = '-10px';
                                handle.style.top = '50%';
                                handle.style.transform = 'translateY(-50%)';
                                break;
                            case 'e':
                                handle.style.right = '-10px';
                                handle.style.top = '50%';
                                handle.style.transform = 'translateY(-50%)';
                                break;
                        }
                    });
                    
                    console.log('í•¸ë“¤ ìœ„ì¹˜ ì„¤ì • ì™„ë£Œ');
            }
            
            // í•¸ë“¤ ì´ë²¤íŠ¸ ì„¤ì • (ë§ˆìš°ìŠ¤ + í„°ì¹˜)
            setupHandleEvents(handles) {
                const img = document.getElementById('processedCalligraphy');
                console.log('í•¸ë“¤ ì´ë²¤íŠ¸ ì„¤ì • ì‹œì‘, í•¸ë“¤ ê°œìˆ˜:', handles.length);
                
                handles.forEach(handle => {
                    console.log('í•¸ë“¤ ì´ë²¤íŠ¸ ì¶”ê°€:', handle.dataset.direction);
                    // ë§ˆìš°ìŠ¤ ì´ë²¤íŠ¸
                    handle.addEventListener('mousedown', (e) => {
                        console.log('í¬ë¡­ í•¸ë“¤ ë“œë˜ê·¸ ì‹œì‘:', handle.dataset.direction);
                        this.isResizing = true;
                        this.resizeHandle = handle.dataset.direction;
                        this.startPos = { x: e.clientX, y: e.clientY };
                        this.startCropArea = { ...this.cropArea };
                        e.preventDefault();
                        e.stopPropagation();
                    });

                    // í„°ì¹˜ ì´ë²¤íŠ¸ (ëª¨ë°”ì¼ ìµœì í™”)
                    handle.addEventListener('touchstart', (e) => {
                        console.log('í¬ë¡­ í•¸ë“¤ í„°ì¹˜ ì‹œì‘:', handle.dataset.direction);
                        this.isResizing = true;
                        this.resizeHandle = handle.dataset.direction;
                        const touch = e.touches[0];
                        // í„°ì¹˜ ì¢Œí‘œë¥¼ ë” ì •í™•í•˜ê²Œ ì €ì¥
                        this.startPos = { 
                            x: touch.clientX, 
                            y: touch.clientY,
                            pageX: touch.pageX,
                            pageY: touch.pageY
                        };
                        this.startCropArea = { ...this.cropArea };
                        // ëª¨ë°”ì¼ì—ì„œëŠ” ì¦‰ì‹œ ì›€ì§ì„ í—ˆìš©
                        this.minMoveDistance = 0; // ëª¨ë°”ì¼ì—ì„œëŠ” ì¦‰ì‹œ ë°˜ì‘
                        this.hasMoved = true; // ì´ë¯¸ ì›€ì§ì¸ ê²ƒìœ¼ë¡œ ê°„ì£¼
                        e.preventDefault();
                        e.stopPropagation();
                    });
                });
            }
        }

        // ì „ì—­ í¬ë¡­ ì‹œìŠ¤í…œ ì¸ìŠ¤í„´ìŠ¤
        const cropSystem = new PreciseCropSystem();
        
        // í„°ì¹˜ ì„±ëŠ¥ ìµœì í™”ë¥¼ ìœ„í•œ ë””ë°”ìš´ì‹± ë³€ìˆ˜
        let touchUpdateTimeout = null;
        
        // í•©ì„± ë¯¸ë¦¬ë³´ê¸° ì—…ë°ì´íŠ¸
        function updateCompositePreview() {
            if (!backgroundImage) return;
            
            const compositeBackground = document.getElementById('compositeBackground');
            const compositeCalligraphy = document.getElementById('compositeCalligraphy');
            
            if (compositeBackground) {
                compositeBackground.src = backgroundImage;
                
                // ë°°ê²½ ì´ë¯¸ì§€ ë¡œë“œ í›„ ë¹„ìœ¨ì— ë”°ë¼ ì¡°ì •
                compositeBackground.onload = () => {
                    adjustBackgroundImageSize(compositeBackground);
                };
            }
            
            if (compositeCalligraphy) {
                // í¬ë¡­ëœ ì´ë¯¸ì§€ê°€ ìˆìœ¼ë©´ ì‚¬ìš©, ì—†ìœ¼ë©´ ì›ë³¸ ì´ë¯¸ì§€ ì‚¬ìš©
                if (croppedCalligraphy) {
                    console.log('í¬ë¡­ëœ ì´ë¯¸ì§€ ì‚¬ìš©:', croppedCalligraphy);
                    compositeCalligraphy.src = croppedCalligraphy;
                } else if (calligraphyImage) {
                    console.log('ì›ë³¸ ì´ë¯¸ì§€ ì‚¬ìš©:', calligraphyImage);
                    compositeCalligraphy.src = calligraphyImage;
                }
                
                compositeCalligraphy.onload = () => {
                    setTimeout(() => {
                        updateEditHandles();
                    }, 100);
                };
            }
            
            compositeSystem.updatePreview();
        }
        
        // ë°°ê²½ ì´ë¯¸ì§€ í¬ê¸° ìë™ ì¡°ì • í•¨ìˆ˜ (í¬ë¡­ê³¼ í•©ì„±ì—ì„œ ë™ì¼í•œ ë°©ì‹ ì ìš©)
        function adjustBackgroundImageSize(imgElement) {
            const container = imgElement.parentElement;
            const containerRect = container.getBoundingClientRect();
            
            // ì»¨í…Œì´ë„ˆì˜ ê°€ë¡œì„¸ë¡œ ë¹„ìœ¨
            const containerAspectRatio = containerRect.width / containerRect.height;
            // ì´ë¯¸ì§€ì˜ ê°€ë¡œì„¸ë¡œ ë¹„ìœ¨
            const imageAspectRatio = imgElement.naturalWidth / imgElement.naturalHeight;
            
            console.log('ë¹„ìœ¨ ë¹„êµ:', {
                container: containerAspectRatio,
                image: imageAspectRatio,
                containerSize: { width: containerRect.width, height: containerRect.height },
                imageSize: { width: imgElement.naturalWidth, height: imgElement.naturalHeight }
            });
            
            // ëª¨ë“  ê²½ìš°ì— object-fit: containì„ ì‚¬ìš©í•˜ì—¬ ì¼ê´€ì„± ë³´ì¥
            imgElement.style.width = '100%';
            imgElement.style.height = '100%';
            imgElement.style.maxWidth = '100%';
            imgElement.style.maxHeight = '100%';
            imgElement.style.objectFit = 'contain';
            imgElement.style.objectPosition = 'center';
            
            console.log('ì¼ê´€ëœ ì´ë¯¸ì§€ í‘œì‹œ ë°©ì‹ ì ìš© - object-fit: contain');
        }
        
        // ê¸€ì”¨ ì´ë¯¸ì§€ì˜ ì‹¤ì œ ìë¥¸ ëª¨ì–‘ ê°ì§€í•˜ì—¬ ë¼ì¸ ìƒì„± (calligraphyOverlay ê¸°ì¤€)
        function createCropOutline() {
            // ê¸°ì¡´ í¬ë¡­ ì•„ì›ƒë¼ì¸ ì œê±°
            const existingOutline = document.querySelector('.crop-outline');
            if (existingOutline) {
                existingOutline.remove();
            }
            
            // calligraphyOverlayì™€ ë™ì¼í•œ í¬ê¸°ë¡œ ì•„ì›ƒë¼ì¸ ìƒì„±
            const calligraphyOverlay = document.getElementById('calligraphyOverlay');
            if (!calligraphyOverlay) return;
            
            const outline = document.createElement('div');
            outline.className = 'crop-outline';
            
            // calligraphyOverlayì˜ ìœ„ì¹˜ì™€ í¬ê¸°ë¥¼ ê·¸ëŒ€ë¡œ ì‚¬ìš©
            const overlayRect = calligraphyOverlay.getBoundingClientRect();
            const previewRect = document.getElementById('compositePreview').getBoundingClientRect();
            
            const relativeLeft = overlayRect.left - previewRect.left;
            const relativeTop = overlayRect.top - previewRect.top;
            
            outline.style.left = relativeLeft + 'px';
            outline.style.top = relativeTop + 'px';
            outline.style.width = overlayRect.width + 'px';
            outline.style.height = overlayRect.height + 'px';
            
            // calligraphyOverlayì™€ ë™ì¼í•œ transform ì ìš©
            const overlayTransform = calligraphyOverlay.style.transform;
            if (overlayTransform) {
                outline.style.transform = overlayTransform;
            }
            
            // composite-previewì— ì¶”ê°€
            document.getElementById('compositePreview').appendChild(outline);
            
            console.log('í¬ë¡­ ì•„ì›ƒë¼ì¸ ìƒì„± (calligraphyOverlay ê¸°ì¤€):', {
                left: relativeLeft,
                top: relativeTop,
                width: overlayRect.width,
                height: overlayRect.height,
                transform: overlayTransform
            });
        }
        
        // í¬ë¡­ëœ ì´ë¯¸ì§€ì˜ ì‹¤ì œ ë‚´ìš© ì˜ì—­ ê°ì§€
        function detectContentBounds(imageSrc) {
            return new Promise((resolve) => {
                if (!imageSrc) {
                    resolve({ x: 0, y: 0, width: 100, height: 100 });
                    return;
                }
                
                const img = new Image();
                img.crossOrigin = 'anonymous';
                
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    
                    // ì›ë³¸ ì´ë¯¸ì§€ í¬ê¸°ë¡œ ìº”ë²„ìŠ¤ ì„¤ì •
                    canvas.width = img.naturalWidth;
                    canvas.height = img.naturalHeight;
                    
                    // ì´ë¯¸ì§€ë¥¼ ìº”ë²„ìŠ¤ì— ê·¸ë¦¬ê¸°
                    ctx.drawImage(img, 0, 0);
                    
                    // ì´ë¯¸ì§€ ë°ì´í„° ë¶„ì„
                    const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                    const data = imageData.data;
                    
                    let minX = canvas.width, minY = canvas.height, maxX = 0, maxY = 0;
                    let hasContent = false;
                    
                    // íˆ¬ëª…ë„ ì„ê³„ê°’ ì„¤ì • (ì™„ì „íˆ íˆ¬ëª…í•˜ì§€ ì•Šì€ í”½ì…€)
                    const alphaThreshold = 20; // ëœ ë¯¼ê°í•˜ê²Œ ì„¤ì •í•˜ì—¬ ì „ì²´ ì˜ì—­ í¬í•¨
                    
                    // ì„±ëŠ¥ì„ ìœ„í•´ ìŠ¤ìº” ê°„ê²© ì¡°ì • (ëª¨ë“  í”½ì…€ì„ í™•ì¸í•˜ì§€ ì•Šê³  ìƒ˜í”Œë§)
                    const scanStep = Math.max(1, Math.floor(Math.min(canvas.width, canvas.height) / 100)); // ëœ ì„¸ë°€í•˜ê²Œ ìŠ¤ìº”
                    
                    console.log(`ì´ë¯¸ì§€ í¬ê¸°: ${canvas.width}x${canvas.height}, ìŠ¤ìº” ê°„ê²©: ${scanStep}`);
                    
                    for (let y = 0; y < canvas.height; y += scanStep) {
                        for (let x = 0; x < canvas.width; x += scanStep) {
                            const index = (y * canvas.width + x) * 4;
                            const alpha = data[index + 3];
                            
                            if (alpha > alphaThreshold) {
                                hasContent = true;
                                minX = Math.min(minX, x);
                                minY = Math.min(minY, y);
                                maxX = Math.max(maxX, x);
                                maxY = Math.max(maxY, y);
                            }
                        }
                    }
                    
                    if (!hasContent) {
                        console.log('í¬ë¡­ëœ ì´ë¯¸ì§€ì—ì„œ ë‚´ìš©ì„ ì°¾ì„ ìˆ˜ ì—†ìŒ');
                        resolve({ x: 0, y: 0, width: 100, height: 100 });
                        return;
                    }
                    
                    // ê²½ê³„ë¥¼ ì•½ê°„ í™•ì¥í•˜ì—¬ ì—¬ë°± ì¶”ê°€ (ë” ê´€ëŒ€í•œ ì—¬ë°± ê³„ì‚°)
                    const padding = Math.max(2, Math.floor(Math.min(canvas.width, canvas.height) / 50)); // ë” í° ì—¬ë°±
                    minX = Math.max(0, minX - padding);
                    minY = Math.max(0, minY - padding);
                    maxX = Math.min(canvas.width, maxX + padding);
                    maxY = Math.min(canvas.height, maxY + padding);
                    
                    // ìµœì†Œ í¬ê¸° ë³´ì¥ (ë„ˆë¬´ ì‘ìœ¼ë©´ í™•ì¥)
                    const minSize = Math.min(canvas.width, canvas.height) / 10; // ë” í° ìµœì†Œ í¬ê¸°
                    if (maxX - minX < minSize) {
                        const centerX = (minX + maxX) / 2;
                        minX = Math.max(0, centerX - minSize / 2);
                        maxX = Math.min(canvas.width, centerX + minSize / 2);
                    }
                    if (maxY - minY < minSize) {
                        const centerY = (minY + maxY) / 2;
                        minY = Math.max(0, centerY - minSize / 2);
                        maxY = Math.min(canvas.height, centerY + minSize / 2);
                    }
                    
                    // í”½ì…€ ì¢Œí‘œë¥¼ í¼ì„¼íŠ¸ë¡œ ë³€í™˜
                    const bounds = {
                        x: (minX / canvas.width) * 100,
                        y: (minY / canvas.height) * 100,
                        width: ((maxX - minX) / canvas.width) * 100,
                        height: ((maxY - minY) / canvas.height) * 100,
                        pixelBounds: { minX, minY, maxX, maxY },
                        originalSize: { width: canvas.width, height: canvas.height }
                    };
                    
                    console.log('ì •í™•í•œ í¬ë¡­ëœ ì´ë¯¸ì§€ ì˜ì—­ ê°ì§€:', bounds);
                    console.log('í”½ì…€ ê²½ê³„:', bounds.pixelBounds);
                    console.log('ì›ë³¸ ì´ë¯¸ì§€ í¬ê¸°:', bounds.originalSize);
                    resolve(bounds);
                };
                img.src = imageSrc;
            });
        }
        
        // í¸ì§‘ í•¸ë“¤ì„ í¬ë¡­ëœ ì´ë¯¸ì§€ ë‚´ìš©ê³¼ ì‹¤ì‹œê°„ ë™ê¸°í™” (ë°˜ì‘í˜• ê°œì„ )
        function syncEditHandlesWithContent() {
            const editHandles = document.getElementById('editHandles');
            const calligraphyOverlay = document.getElementById('calligraphyOverlay');
            const compositePreview = document.getElementById('compositePreview');
            
            if (!editHandles || !calligraphyOverlay || !compositePreview || !croppedCalligraphy) return;
            
            // í¬ë¡­ëœ ì´ë¯¸ì§€ ë‚´ìš© ì˜ì—­ ë‹¤ì‹œ ê³„ì‚°
            detectContentBounds(croppedCalligraphy).then((bounds) => {
                // calligraphyOverlayì˜ í˜„ì¬ ìœ„ì¹˜ì™€ í¬ê¸° (compositePreview ê¸°ì¤€)
                const overlayRect = calligraphyOverlay.getBoundingClientRect();
                const previewRect = compositePreview.getBoundingClientRect();
                
                // ë””ë²„ê¹… ì˜ì—­ê³¼ ì •í™•íˆ ë™ì¼í•œ ìœ„ì¹˜ì— í¸ì§‘ í•¸ë“¤ ë°°ì¹˜
                const contentXPercent = bounds.x;
                const contentYPercent = bounds.y;
                const contentWidthPercent = bounds.width;
                const contentHeightPercent = bounds.height;
                
                console.log('í¸ì§‘ í•¸ë“¤ ìœ„ì¹˜ ê³„ì‚° (ë””ë²„ê¹… ì˜ì—­ê³¼ ë™ì¼):', {
                    contentBounds: bounds,
                    position: { left: contentXPercent, top: contentYPercent, width: contentWidthPercent, height: contentHeightPercent }
                });
                
                // í¸ì§‘ í•¸ë“¤ ìœ„ì¹˜ì™€ í¬ê¸° ì„¤ì • (í¬ë¡­ëœ ì´ë¯¸ì§€ ë‚´ìš©ì— ë§ì¶°)
                editHandles.style.position = 'absolute';
                editHandles.style.left = `${contentXPercent}%`;
                editHandles.style.top = `${contentYPercent}%`;
                editHandles.style.width = `${contentWidthPercent}%`;
                editHandles.style.height = `${contentHeightPercent}%`;
                editHandles.style.margin = '0';
                editHandles.style.padding = '0';
                editHandles.style.transform = 'none';
                editHandles.style.transformOrigin = 'center';
                editHandles.style.display = 'block';
                editHandles.style.opacity = '1';
                editHandles.style.visibility = 'visible';
                editHandles.style.pointerEvents = 'auto';
                editHandles.style.zIndex = '10';
                
                // í¸ì§‘ í•¸ë“¤ì´ ì´ë¯¸ calligraphyOverlayì˜ ìì‹ìœ¼ë¡œ ì˜¬ë°”ë¥´ê²Œ ìœ„ì¹˜í•¨
                console.log('í¸ì§‘ í•¸ë“¤ ë¶€ëª¨ í™•ì¸:', editHandles.parentNode?.id);
                
                // í¸ì§‘ í•¸ë“¤ DOM êµ¬ì¡° ë””ë²„ê¹…
                console.log('í¸ì§‘ í•¸ë“¤ DOM êµ¬ì¡°:', {
                    parentNode: editHandles.parentNode?.id || editHandles.parentNode?.tagName,
                    position: editHandles.style.position,
                    left: editHandles.style.left,
                    top: editHandles.style.top,
                    width: editHandles.style.width,
                    height: editHandles.style.height,
                    zIndex: editHandles.style.zIndex,
                    opacity: editHandles.style.opacity,
                    visibility: editHandles.style.visibility
                });
                
                console.log('í¸ì§‘ í•¸ë“¤ calligraphyOverlay ê¸°ì¤€ ë™ê¸°í™” ì™„ë£Œ:', {
                    contentBounds: bounds,
                    position: { left: contentXPercent, top: contentYPercent, width: contentWidthPercent, height: contentHeightPercent },
                    parentTransform: calligraphyOverlay.style.transform
                });
                
                // ë””ë²„ê¹… ì˜ì—­ ìƒì„± ë¹„í™œì„±í™” (ì‚¬ìš©ì ìš”ì²­ì— ë”°ë¼ ì œê±°)
            });
        }
        
        // í¸ì§‘ í•¸ë“¤ ìœ„ì¹˜ ì—…ë°ì´íŠ¸ (compositePreview ë‚´ë¶€ì— ìœ„ì¹˜)
        function updateEditHandles() {
            const editHandles = document.getElementById('editHandles');
            const calligraphyOverlay = document.getElementById('calligraphyOverlay');
            if (!editHandles || !calligraphyOverlay) return;
            
            console.log('í¸ì§‘ í•¸ë“¤ ì—…ë°ì´íŠ¸ ì‹œì‘ - calligraphyOverlay ë‚´ë¶€');
            
            // í¸ì§‘ í•¸ë“¤ì„ calligraphyOverlayì™€ ë™ì¼í•˜ê²Œ ì„¤ì •
            editHandles.style.position = 'absolute';
            editHandles.style.left = calligraphyOverlay.style.left || '0%';
            editHandles.style.top = calligraphyOverlay.style.top || '0%';
            editHandles.style.width = calligraphyOverlay.style.width || '100%';
            editHandles.style.height = calligraphyOverlay.style.height || '100%';
            editHandles.style.transform = calligraphyOverlay.style.transform || 'none';
            editHandles.style.display = 'block';
            editHandles.style.opacity = '1';
            editHandles.style.visibility = 'visible';
            editHandles.style.pointerEvents = 'auto';
            editHandles.style.zIndex = '10';
            
            console.log('í¸ì§‘ í•¸ë“¤ ìœ„ì¹˜ ì„¤ì • ì™„ë£Œ:', {
                left: editHandles.style.left,
                top: editHandles.style.top,
                width: editHandles.style.width,
                height: editHandles.style.height,
                transform: editHandles.style.transform
            });
            
            // ì‹¤ì‹œê°„ ìœ„ì¹˜ ë™ê¸°í™”ë¥¼ ìœ„í•œ MutationObserver ì„¤ì •
            if (!window.editHandlesObserver) {
                window.editHandlesObserver = new MutationObserver(() => {
                    syncEditHandlesWithContent();
                });
                
                // calligraphyOverlayì˜ ìŠ¤íƒ€ì¼ ë³€í™” ê°ì§€
                window.editHandlesObserver.observe(calligraphyOverlay, {
                    attributes: true,
                    attributeFilter: ['style']
                });
            }
            
            // ResizeObserverë¥¼ ì‚¬ìš©í•˜ì—¬ ë” ì •í™•í•œ í¬ê¸° ë³€í™” ê°ì§€
            if (!window.editHandlesResizeObserver) {
                let resizeTimeout;
                window.editHandlesResizeObserver = new ResizeObserver(() => {
                    // ë””ë°”ìš´ì‹±ìœ¼ë¡œ ì„±ëŠ¥ ìµœì í™”
                    clearTimeout(resizeTimeout);
                    resizeTimeout = setTimeout(() => {
                        syncEditHandlesWithContent();
                    }, 16); // 60fpsì— ë§ì¶° 16ms ê°„ê²©
                });
                
                // compositePreviewì™€ calligraphyOverlay í¬ê¸° ë³€í™” ê°ì§€
                const compositePreview = document.getElementById('compositePreview');
                if (compositePreview) {
                    window.editHandlesResizeObserver.observe(compositePreview);
                }
                window.editHandlesResizeObserver.observe(calligraphyOverlay);
            }
            
            // í¬ë¡­ëœ ì´ë¯¸ì§€ê°€ ìˆìœ¼ë©´ syncEditHandlesWithContentë¡œ ì •í™•í•œ ìœ„ì¹˜ ì„¤ì •
            if (croppedCalligraphy) {
                setTimeout(() => {
                    syncEditHandlesWithContent();
                }, 100);
            }
            
            // í•¸ë“¤ ìœ„ì¹˜ ì¡°ì • (ê³ ì • í¬ê¸° ìœ ì§€)
            const scaleHandle = document.getElementById('scaleHandle');
            const rotateHandle = document.getElementById('rotateHandle');
            
            if (scaleHandle) {
                scaleHandle.style.right = '-20px';
                scaleHandle.style.bottom = '-20px';
                scaleHandle.style.width = '40px !important';
                scaleHandle.style.height = '40px !important';
                scaleHandle.style.minWidth = '40px !important';
                scaleHandle.style.minHeight = '40px !important';
                scaleHandle.style.maxWidth = '40px !important';
                scaleHandle.style.maxHeight = '40px !important';
                scaleHandle.style.transform = 'none !important';
            }
            
            if (rotateHandle) {
                rotateHandle.style.right = '-20px';
                rotateHandle.style.top = '-20px';
                rotateHandle.style.width = '40px !important';
                rotateHandle.style.height = '40px !important';
                rotateHandle.style.minWidth = '40px !important';
                rotateHandle.style.minHeight = '40px !important';
                rotateHandle.style.maxWidth = '40px !important';
                rotateHandle.style.maxHeight = '40px !important';
                rotateHandle.style.transform = 'none !important';
            }
            
            console.log('í¸ì§‘ í•¸ë“¤ ì—…ë°ì´íŠ¸ ì™„ë£Œ - compositePreview ë‚´ë¶€ì— ìœ„ì¹˜');
        }
        
        
        // ìƒˆë¡œìš´ ì •í™•í•œ í•©ì„± ì‹œìŠ¤í…œ
        class PreciseCompositeSystem {
            constructor() {
                this.position = { x: 50, y: 50 }; // í¼ì„¼íŠ¸ ë‹¨ìœ„
                this.scale = 0.3; // ë°°ê²½ì˜ 30% í¬ê¸°ë¡œ ì‹œì‘ (ë” ì‘ê²Œ)
                this.rotation = 0;
                this.blendMode = 'multiply';
                this.bounds = { x: 0, y: 0, width: 100, height: 100 }; // ê¸€ì”¨ì˜ ì‹¤ì œ ê²½ê³„
                this.backgroundDisplayBounds = null; // ë°°ê²½ ì´ë¯¸ì§€ì˜ ì‹¤ì œ í‘œì‹œ ì˜ì—­
            }

            // ë°°ê²½ ì´ë¯¸ì§€ì˜ ì‹¤ì œ í‘œì‹œ ì˜ì—­ ê³„ì‚° (í¬ë¡­ ì‹œìŠ¤í…œê³¼ ë™ì¼í•œ ë°©ì‹)
            getBackgroundDisplayBounds(imgElement) {
                const imgRect = imgElement.getBoundingClientRect();
                
                // CSS object-fit: containìœ¼ë¡œ ì¸í•œ ì‹¤ì œ ì´ë¯¸ì§€ ì˜ì—­ ê³„ì‚°
                const imgAspectRatio = imgElement.naturalWidth / imgElement.naturalHeight;
                const containerAspectRatio = imgRect.width / imgRect.height;
                
                let actualWidth, actualHeight, offsetX, offsetY;
                
                if (containerAspectRatio > imgAspectRatio) {
                    // ì»¨í…Œì´ë„ˆê°€ ë” ë„“ìŒ - ì´ë¯¸ì§€ê°€ ì„¸ë¡œë¡œ ë§ì¶°ì§
                    actualHeight = imgRect.height;
                    actualWidth = imgRect.height * imgAspectRatio;
                    offsetX = (imgRect.width - actualWidth) / 2;
                    offsetY = 0;
                } else {
                    // ì»¨í…Œì´ë„ˆê°€ ë” ë†’ìŒ - ì´ë¯¸ì§€ê°€ ê°€ë¡œë¡œ ë§ì¶°ì§
                    actualWidth = imgRect.width;
                    actualHeight = imgRect.width / imgAspectRatio;
                    offsetX = 0;
                    offsetY = (imgRect.height - actualHeight) / 2;
                }
                
                const bounds = {
                    x: imgRect.left + offsetX,
                    y: imgRect.top + offsetY,
                    width: actualWidth,
                    height: actualHeight,
                    offsetX,
                    offsetY,
                    originalWidth: imgElement.naturalWidth,
                    originalHeight: imgElement.naturalHeight,
                    containerWidth: imgRect.width,
                    containerHeight: imgRect.height,
                    aspectRatio: imgAspectRatio,
                    containerAspectRatio: containerAspectRatio
                };
                
                console.log('ë°°ê²½ ì´ë¯¸ì§€ í‘œì‹œ ì˜ì—­:', bounds);
                return bounds;
            }

            // ì˜ë¼ì§„ ì´ë¯¸ì§€ì˜ ì‹¤ì œ ê²½ê³„ ê°ì§€
            detectImageBounds() {
                return new Promise((resolve) => {
                    if (!croppedCalligraphy) {
                        this.bounds = { x: 0, y: 0, width: 100, height: 100 };
                        resolve(this.bounds);
                        return;
                    }
                    
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        
                        canvas.width = img.naturalWidth;
                        canvas.height = img.naturalHeight;
                        
                        ctx.drawImage(img, 0, 0);
                        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                        const data = imageData.data;
                        
                        let minX = canvas.width, minY = canvas.height, maxX = 0, maxY = 0;
                        let hasContent = false;
                        
                        // í”½ì…€ì„ ìŠ¤ìº”í•˜ì—¬ ì‹¤ì œ ë‚´ìš©ì´ ìˆëŠ” ì˜ì—­ ì°¾ê¸°
                        for (let y = 0; y < canvas.height; y++) {
                            for (let x = 0; x < canvas.width; x++) {
                                const index = (y * canvas.width + x) * 4;
                                const alpha = data[index + 3];
                                
                                if (alpha > 0) { // íˆ¬ëª…í•˜ì§€ ì•Šì€ í”½ì…€
                                    hasContent = true;
                                    minX = Math.min(minX, x);
                                    minY = Math.min(minY, y);
                                    maxX = Math.max(maxX, x);
                                    maxY = Math.max(maxY, y);
                                }
                            }
                        }
                        
                        if (hasContent) {
                            // í¼ì„¼íŠ¸ë¡œ ë³€í™˜
                            this.bounds = {
                                x: (minX / canvas.width) * 100,
                                y: (minY / canvas.height) * 100,
                                width: ((maxX - minX) / canvas.width) * 100,
                                height: ((maxY - minY) / canvas.height) * 100
                            };
                        } else {
                            this.bounds = { x: 0, y: 0, width: 100, height: 100 };
                        }
                        
                        console.log('ì˜ë¼ì§„ ì´ë¯¸ì§€ ê²½ê³„ ê°ì§€:', this.bounds);
                        resolve(this.bounds);
                    };
                    img.src = croppedCalligraphy;
                });
            }

            // ë°°ê²½ ì´ë¯¸ì§€ì˜ ì‹¤ì œ í‘œì‹œ ì˜ì—­ì— ë§ì¶° ê¸€ì”¨ ì´ë¯¸ì§€ í¬ê¸° ì¡°ì •
            adjustCalligraphyToBackground() {
                if (!this.backgroundDisplayBounds || !croppedCalligraphy) return;
                
                const calligraphyOverlay = document.getElementById('calligraphyOverlay');
                if (!calligraphyOverlay) return;
                
                // ë°°ê²½ ì´ë¯¸ì§€ì˜ ì‹¤ì œ í‘œì‹œ ì˜ì—­ ë¹„ìœ¨ ê³„ì‚°
                const backgroundRatio = this.backgroundDisplayBounds.width / this.backgroundDisplayBounds.height;
                
                // í¬ë¡­ëœ ì´ë¯¸ì§€ì˜ ë¹„ìœ¨ ê³„ì‚°
                const img = new Image();
                img.onload = () => {
                    const calligraphyRatio = img.naturalWidth / img.naturalHeight;
                    
                    console.log('ë¹„ìœ¨ ë¹„êµ:', {
                        background: backgroundRatio,
                        calligraphy: calligraphyRatio,
                        backgroundBounds: this.backgroundDisplayBounds
                    });
                    
                    // ë°°ê²½ ì´ë¯¸ì§€ì˜ ì‹¤ì œ í‘œì‹œ ì˜ì—­ì— ë§ì¶° ê¸€ì”¨ ì˜¤ë²„ë ˆì´ í¬ê¸° ì¡°ì •
                    if (backgroundRatio > calligraphyRatio) {
                        // ë°°ê²½ì´ ë” ë„“ìŒ - ê¸€ì”¨ë¥¼ ì„¸ë¡œë¡œ ë§ì¶¤
                        calligraphyOverlay.style.width = 'auto';
                        calligraphyOverlay.style.height = '100%';
                        calligraphyOverlay.style.maxWidth = '100%';
                        calligraphyOverlay.style.maxHeight = '100%';
                    } else {
                        // ë°°ê²½ì´ ë” ë†’ìŒ - ê¸€ì”¨ë¥¼ ê°€ë¡œë¡œ ë§ì¶¤
                        calligraphyOverlay.style.width = '100%';
                        calligraphyOverlay.style.height = 'auto';
                        calligraphyOverlay.style.maxWidth = '100%';
                        calligraphyOverlay.style.maxHeight = '100%';
                    }
                    
                    calligraphyOverlay.style.objectFit = 'contain';
                    calligraphyOverlay.style.objectPosition = 'center';
                    
                    console.log('ê¸€ì”¨ ì´ë¯¸ì§€ í¬ê¸° ì¡°ì • ì™„ë£Œ');
                };
                img.src = croppedCalligraphy;
            }

            // ë¯¸ë¦¬ë³´ê¸° ì—…ë°ì´íŠ¸ (CSS Transform ì‚¬ìš©)
            updatePreview() {
                if (!backgroundImage) return;
                
                const compositeBackground = document.getElementById('compositeBackground');
                const compositeCalligraphy = document.getElementById('compositeCalligraphy');
                const calligraphyOverlay = document.getElementById('calligraphyOverlay');
                const editHandles = document.getElementById('editHandles');
                
                if (!compositeBackground || !compositeCalligraphy || !calligraphyOverlay) return;
                
                compositeBackground.src = backgroundImage;
                
                // ë°°ê²½ ì´ë¯¸ì§€ ë¡œë“œ í›„ ë¹„ìœ¨ì— ë”°ë¼ ì¡°ì •
                compositeBackground.onload = () => {
                    adjustBackgroundImageSize(compositeBackground);
                    // ë°°ê²½ ì´ë¯¸ì§€ì˜ ì‹¤ì œ í‘œì‹œ ì˜ì—­ ê³„ì‚° ë° ì €ì¥
                    this.backgroundDisplayBounds = this.getBackgroundDisplayBounds(compositeBackground);
                };
                
                // í¬ë¡­ëœ ì´ë¯¸ì§€ê°€ ìˆìœ¼ë©´ ì‚¬ìš©, ì—†ìœ¼ë©´ ì›ë³¸ ì´ë¯¸ì§€ ì‚¬ìš©
                if (croppedCalligraphy) {
                    console.log('compositeSystemì—ì„œ í¬ë¡­ëœ ì´ë¯¸ì§€ ì‚¬ìš©:', croppedCalligraphy);
                    compositeCalligraphy.src = croppedCalligraphy;
                } else if (calligraphyImage) {
                    console.log('compositeSystemì—ì„œ ì›ë³¸ ì´ë¯¸ì§€ ì‚¬ìš©:', calligraphyImage);
                    compositeCalligraphy.src = calligraphyImage;
                } else {
                    return;
                }
                
                // ì˜ë¼ì§„ ì´ë¯¸ì§€ ê²½ê³„ ê°ì§€
                this.detectImageBounds().then(() => {
                    // ë°°ê²½ ì´ë¯¸ì§€ì˜ ì‹¤ì œ í‘œì‹œ ì˜ì—­ì— ë§ì¶° ê¸€ì”¨ ì´ë¯¸ì§€ í¬ê¸° ì¡°ì •
                    this.adjustCalligraphyToBackground();
                    this.updateEditHandles();
                });
                
                // ìœ„ì¹˜, í¬ê¸°, íšŒì „ ì ìš©
                const transform = `translate(-50%, -50%) scale(${this.scale}) rotate(${this.rotation}deg)`;
                calligraphyOverlay.style.left = `${this.position.x}%`;
                calligraphyOverlay.style.top = `${this.position.y}%`;
                calligraphyOverlay.style.transform = transform;
                
                // í¸ì§‘ í•¸ë“¤ì„ calligraphyOverlayì™€ ì •í™•íˆ ë™ì¼í•œ ìœ„ì¹˜ì™€ í¬ê¸°ë¡œ ì„¤ì •
                if (editHandles) {
                    // calligraphyOverlayì™€ ë™ì¼í•œ CSS ì†ì„± ì ìš©
                    editHandles.style.left = calligraphyOverlay.style.left;
                    editHandles.style.top = calligraphyOverlay.style.top;
                    editHandles.style.width = calligraphyOverlay.style.width;
                    editHandles.style.height = calligraphyOverlay.style.height;
                    editHandles.style.transform = calligraphyOverlay.style.transform;
                }
                
                console.log('ë¯¸ë¦¬ë³´ê¸° ì—…ë°ì´íŠ¸:', {
                    position: this.position,
                    scale: this.scale,
                    rotation: this.rotation,
                    blendMode: this.blendMode,
                    bounds: this.bounds,
                    transform: transform
                });
                
                // ë¸”ë Œë“œ ëª¨ë“œ ì ìš©
                if (this.blendMode === 'screen') {
                    calligraphyOverlay.style.filter = 'invert(1)';
                    calligraphyOverlay.style.mixBlendMode = 'screen';
                } else {
                    calligraphyOverlay.style.filter = 'none';
                    calligraphyOverlay.style.mixBlendMode = 'multiply';
                }
            }
            
            // í¸ì§‘ í•¸ë“¤ ìœ„ì¹˜ ì—…ë°ì´íŠ¸ (compositePreview ë‚´ë¶€ì— ìœ„ì¹˜)
            updateEditHandles() {
                const editHandles = document.getElementById('editHandles');
                const calligraphyOverlay = document.getElementById('calligraphyOverlay');
                if (!editHandles || !calligraphyOverlay) return;
                
                console.log('compositeSystem í¸ì§‘ í•¸ë“¤ ì—…ë°ì´íŠ¸ ì‹œì‘ - compositePreview ë‚´ë¶€');
                
                // calligraphyOverlayì™€ ë™ì¼í•œ CSS ì†ì„± ì ìš©
                editHandles.style.left = calligraphyOverlay.style.left;
                editHandles.style.top = calligraphyOverlay.style.top;
                editHandles.style.width = calligraphyOverlay.style.width;
                editHandles.style.height = calligraphyOverlay.style.height;
                editHandles.style.transform = calligraphyOverlay.style.transform;
                editHandles.style.display = 'block';
                
                // í¬ë¡­ëœ ì´ë¯¸ì§€ê°€ ìˆìœ¼ë©´ syncEditHandlesWithContentë¡œ ì •í™•í•œ ìœ„ì¹˜ ì„¤ì •
                if (croppedCalligraphy) {
                    setTimeout(() => {
                        syncEditHandlesWithContent();
                    }, 100);
                }
                
                // í•¸ë“¤ í¬ê¸° ê³ ì •
                const scaleHandle = document.getElementById('scaleHandle');
                const rotateHandle = document.getElementById('rotateHandle');
                
                if (scaleHandle) {
                    scaleHandle.style.width = '40px !important';
                    scaleHandle.style.height = '40px !important';
                    scaleHandle.style.minWidth = '40px !important';
                    scaleHandle.style.minHeight = '40px !important';
                    scaleHandle.style.maxWidth = '40px !important';
                    scaleHandle.style.maxHeight = '40px !important';
                    scaleHandle.style.transform = 'none !important';
                }
                
                if (rotateHandle) {
                    rotateHandle.style.width = '40px !important';
                    rotateHandle.style.height = '40px !important';
                    rotateHandle.style.minWidth = '40px !important';
                    rotateHandle.style.minHeight = '40px !important';
                    rotateHandle.style.maxWidth = '40px !important';
                    rotateHandle.style.maxHeight = '40px !important';
                    rotateHandle.style.transform = 'none !important';
                }
                
                console.log('compositeSystem í¸ì§‘ í•¸ë“¤ ì—…ë°ì´íŠ¸ ì™„ë£Œ - compositePreview ë‚´ë¶€ì— ìœ„ì¹˜');
            }

            // ì •í™•í•œ ë‹¤ìš´ë¡œë“œ ì´ë¯¸ì§€ ìƒì„± (ì›ë³¸ ë°°ê²½ ì´ë¯¸ì§€ í¬ê¸°ì— ë§ì¶¤)
            async downloadImage() {
                return new Promise((resolve) => {
                    // ë¯¸ë¦¬ë³´ê¸° ì˜ì—­ì˜ ì •í™•í•œ í¬ê¸°ì™€ ìœ„ì¹˜ ê°€ì ¸ì˜¤ê¸°
                    const previewElement = document.getElementById('compositePreview');
                    const calligraphyOverlay = document.getElementById('calligraphyOverlay');
                    const compositeBackground = document.getElementById('compositeBackground');
                    
                    if (!previewElement || !calligraphyOverlay || !compositeBackground) {
                        console.error('ë¯¸ë¦¬ë³´ê¸° ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                        resolve();
                        return;
                    }
                    
                    const previewRect = previewElement.getBoundingClientRect();
                    const overlayRect = calligraphyOverlay.getBoundingClientRect();
                    
                    // ë°°ê²½ ì´ë¯¸ì§€ì˜ ì‹¤ì œ í‘œì‹œ ì˜ì—­ ê³„ì‚°
                    const backgroundBounds = this.getBackgroundDisplayBounds(compositeBackground);
                    
                    // ì›ë³¸ ë°°ê²½ ì´ë¯¸ì§€ í¬ê¸°ë¡œ ìº”ë²„ìŠ¤ ìƒì„±
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    
                    // ë°°ê²½ ì´ë¯¸ì§€ ê·¸ë¦¬ê¸°
                    const bgImg = new Image();
                    bgImg.onload = () => {
                        // ì›ë³¸ ë°°ê²½ ì´ë¯¸ì§€ í¬ê¸°ë¡œ ìº”ë²„ìŠ¤ ì„¤ì •
                        canvas.width = bgImg.naturalWidth;
                        canvas.height = bgImg.naturalHeight;
                        
                        // ì›ë³¸ ë°°ê²½ ì´ë¯¸ì§€ ê·¸ë¦¬ê¸° (ì „ì²´ í¬ê¸°)
                        ctx.drawImage(bgImg, 0, 0, canvas.width, canvas.height);
                        
                        console.log('ë‹¤ìš´ë¡œë“œ ìº”ë²„ìŠ¤ í¬ê¸° (ì›ë³¸ ë°°ê²½ ì´ë¯¸ì§€):', {
                            width: canvas.width,
                            height: canvas.height,
                            originalSize: { width: bgImg.naturalWidth, height: bgImg.naturalHeight }
                        });
                        
                        // ê¸€ì”¨ ì˜¤ë²„ë ˆì´ ê·¸ë¦¬ê¸°
                        const calligraphyImg = new Image();
                        calligraphyImg.onload = () => {
                            ctx.save();
                            
                            // ë¯¸ë¦¬ë³´ê¸°ì—ì„œì˜ ê¸€ì”¨ ìœ„ì¹˜ì™€ í¬ê¸°ë¥¼ ì›ë³¸ ë°°ê²½ ì´ë¯¸ì§€ í¬ê¸°ë¡œ ë³€í™˜
                            const scaleX = canvas.width / backgroundBounds.width;
                            const scaleY = canvas.height / backgroundBounds.height;
                            
                            // ë¯¸ë¦¬ë³´ê¸°ì—ì„œì˜ ê¸€ì”¨ ì¤‘ì‹¬ì ì„ ì›ë³¸ ë°°ê²½ ì´ë¯¸ì§€ ì¢Œí‘œë¡œ ë³€í™˜
                            const previewCenterX = overlayRect.left - previewRect.left + overlayRect.width / 2;
                            const previewCenterY = overlayRect.top - previewRect.top + overlayRect.height / 2;
                            
                            // ë°°ê²½ ì´ë¯¸ì§€ì˜ ì‹¤ì œ í‘œì‹œ ì˜ì—­ ë‚´ì—ì„œì˜ ìƒëŒ€ ìœ„ì¹˜ ê³„ì‚°
                            const relativeX = (previewCenterX - backgroundBounds.offsetX) / backgroundBounds.width;
                            const relativeY = (previewCenterY - backgroundBounds.offsetY) / backgroundBounds.height;
                            
                            // ì›ë³¸ ë°°ê²½ ì´ë¯¸ì§€ì—ì„œì˜ ì‹¤ì œ ìœ„ì¹˜
                            const centerX = relativeX * canvas.width;
                            const centerY = relativeY * canvas.height;
                            
                            // ê¸€ì”¨ í¬ê¸°ë¥¼ ì›ë³¸ ë°°ê²½ ì´ë¯¸ì§€ì— ë§ê²Œ ì¡°ì •
                            const calligraphyWidth = overlayRect.width * scaleX;
                            const calligraphyHeight = overlayRect.height * scaleY;
                            
                            console.log('ë‹¤ìš´ë¡œë“œ ì´ë¯¸ì§€ ìƒì„± (ì›ë³¸ ë°°ê²½ í¬ê¸°):', {
                                canvasSize: { width: canvas.width, height: canvas.height },
                                backgroundBounds: backgroundBounds,
                                scaleFactors: { scaleX, scaleY },
                                previewCenter: { x: previewCenterX, y: previewCenterY },
                                relativePosition: { x: relativeX, y: relativeY },
                                finalCenter: { x: centerX, y: centerY },
                                calligraphySize: { width: calligraphyWidth, height: calligraphyHeight },
                                rotation: this.rotation,
                                blendMode: this.blendMode
                            });
                            
                            // íšŒì „ ì¤‘ì‹¬ì ìœ¼ë¡œ ì´ë™
                            ctx.translate(centerX, centerY);
                            ctx.rotate((this.rotation * Math.PI) / 180);
                            
                            // ë¸”ë Œë“œ ëª¨ë“œ ì„¤ì • (ë¯¸ë¦¬ë³´ê¸°ì™€ ë™ì¼)
                            if (this.blendMode === 'screen') {
                                ctx.globalCompositeOperation = 'screen';
                                ctx.filter = 'invert(1)';
                            } else {
                                ctx.globalCompositeOperation = 'multiply';
                                ctx.filter = 'none';
                            }
                            
                            // íšŒì „ëœ ì´ë¯¸ì§€ì˜ ì›ë³¸ í¬ê¸° ìœ ì§€ (ëŠ˜ì–´ë‚¨ ë°©ì§€)
                            const originalCalligraphyWidth = calligraphyImg.naturalWidth;
                            const originalCalligraphyHeight = calligraphyImg.naturalHeight;
                            
                            // ìŠ¤ì¼€ì¼ ë¹„ìœ¨ ê³„ì‚° (íšŒì „ ì‹œ í¬ê¸° ë³€í™” ë°©ì§€)
                            const scaleRatio = Math.min(calligraphyWidth / originalCalligraphyWidth, calligraphyHeight / originalCalligraphyHeight);
                            const finalWidth = originalCalligraphyWidth * scaleRatio;
                            const finalHeight = originalCalligraphyHeight * scaleRatio;
                            
                            // ì›ë³¸ ë¹„ìœ¨ì„ ìœ ì§€í•˜ë©° ê¸€ì”¨ ê·¸ë¦¬ê¸° (ì¤‘ì‹¬ì  ê¸°ì¤€)
                            ctx.drawImage(calligraphyImg, -finalWidth / 2, -finalHeight / 2, finalWidth, finalHeight);
                            ctx.restore();
                            
                            // ëª¨ë°”ì¼ í˜¸í™˜ ë‹¤ìš´ë¡œë“œ
                            const dataURL = canvas.toDataURL('image/jpeg', 0.9);
                            const fileName = 'calligraphy-composite.jpg';
                            
                            // ëª¨ë°”ì¼ ê°ì§€
                            const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
                            
                            if (isMobile) {
                                // ëª¨ë°”ì¼ì—ì„œ ê°¤ëŸ¬ë¦¬ì— ë°”ë¡œ ì €ì¥
                                saveToGallery(canvas, fileName);
                            } else {
                                // ë°ìŠ¤í¬í†±ì—ì„œëŠ” ì¼ë°˜ ë‹¤ìš´ë¡œë“œ
                                const link = document.createElement('a');
                                link.download = fileName;
                                link.href = dataURL;
                                link.click();
                            }
                            
                            resolve();
                        };
                        calligraphyImg.src = croppedCalligraphy;
                    };
                    bgImg.src = backgroundImage;
                });
            }

            // ìœ„ì¹˜ ì—…ë°ì´íŠ¸
            updatePosition(x, y) {
                this.position.x = Math.max(0, Math.min(100, x));
                this.position.y = Math.max(0, Math.min(100, y));
                this.updatePreview();
            }

            // í¬ê¸° ì—…ë°ì´íŠ¸
            updateScale(scale) {
                this.scale = Math.max(0.1, Math.min(5, scale));
                this.updatePreview();
                this.updateEditHandles();
            }

            // íšŒì „ ì—…ë°ì´íŠ¸
            updateRotation(rotation) {
                this.rotation = rotation;
                this.updatePreview();
                this.updateEditHandles();
            }

            // ë¸”ë Œë“œ ëª¨ë“œ ì—…ë°ì´íŠ¸
            updateBlendMode(mode) {
                this.blendMode = mode;
                this.updatePreview();
            }
        }

        // ì „ì—­ í•©ì„± ì‹œìŠ¤í…œ ì¸ìŠ¤í„´ìŠ¤
        const compositeSystem = new PreciseCompositeSystem();
        
        // ëª¨ë°”ì¼ ê°¤ëŸ¬ë¦¬ ì €ì¥ í•¨ìˆ˜
        function saveToGallery(canvas, fileName) {
            // Canvasë¥¼ Blobìœ¼ë¡œ ë³€í™˜
            canvas.toBlob((blob) => {
                if (!blob) {
                    console.error('Canvasë¥¼ Blobìœ¼ë¡œ ë³€í™˜ ì‹¤íŒ¨');
                    showSaveErrorModal();
                    return;
                }
                
                // iOS Safariì—ì„œ ê°¤ëŸ¬ë¦¬ ì €ì¥
                if (/iPad|iPhone|iPod/.test(navigator.userAgent)) {
                    saveToGalleryIOS(blob, fileName);
                } 
                // Android Chromeì—ì„œ ê°¤ëŸ¬ë¦¬ ì €ì¥
                else if (/Android/.test(navigator.userAgent)) {
                    saveToGalleryAndroid(blob, fileName);
                } 
                // ê¸°íƒ€ ëª¨ë°”ì¼ ë¸Œë¼ìš°ì €
                else {
                    saveToGalleryGeneric(blob, fileName);
                }
            }, 'image/jpeg', 0.9);
        }
        
        // iOS Safari ê°¤ëŸ¬ë¦¬ ì €ì¥ (ê°œì„ ëœ ë°©ë²•)
        function saveToGalleryIOS(blob, fileName) {
            const url = URL.createObjectURL(blob);
            
            // iOSì—ì„œ ë” ì•ˆì •ì ì¸ ì €ì¥ ë°©ë²• ì‚¬ìš©
            tryAutoSaveIOS(url, fileName);
        }
        
        // iOS ìë™ ì €ì¥ ì‹œë„ (ê°œì„ ëœ ë²„ì „)
        function tryAutoSaveIOS(url, fileName) {
            console.log('iOS ì €ì¥ ì‹œë„ ì‹œì‘');
            
            // iOSì—ì„œëŠ” ìë™ ì €ì¥ì´ ì œí•œì ì´ë¯€ë¡œ ì¦‰ì‹œ ìˆ˜ë™ ì €ì¥ ëª¨ë‹¬ í‘œì‹œ
            showIOSSaveModal(url, fileName);
        }
        
        // iOS ì „ìš© ì €ì¥ ëª¨ë‹¬ (ë” ê°„í¸í•œ ì €ì¥ ë°©ë²• ì œê³µ)
        function showIOSSaveModal(dataURL, fileName) {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.8);
                z-index: 10000;
                display: flex;
                justify-content: center;
                align-items: center;
                padding: 20px;
                box-sizing: border-box;
            `;
            
            modal.innerHTML = `
                <div style="
                    background: white;
                    border-radius: 15px;
                    padding: 30px;
                    max-width: 90%;
                    max-height: 90%;
                    text-align: center;
                    overflow-y: auto;
                ">
                    <h3 style="margin: 0 0 20px 0; color: #333; font-size: 20px; font-weight: bold;">ğŸ“± iOS ì´ë¯¸ì§€ ì €ì¥</h3>
                    <img src="${dataURL}" style="
                        max-width: 100%;
                        max-height: 300px;
                        height: auto;
                        border: 3px solid #007AFF;
                        border-radius: 15px;
                        margin-bottom: 25px;
                        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                    ">
                    <div style="margin: 25px 0;">
                        <button onclick="downloadImageDirectly('${dataURL}', '${fileName}')" style="
                            background: linear-gradient(135deg, #007AFF, #0056CC);
                            color: white;
                            border: none;
                            padding: 18px 35px;
                            border-radius: 12px;
                            font-size: 17px;
                            font-weight: bold;
                            cursor: pointer;
                            margin: 8px 0;
                            width: 100%;
                            box-shadow: 0 4px 12px rgba(0,122,255,0.3);
                            transition: all 0.2s ease;
                        " onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">ğŸ’¾ ì €ì¥í•˜ê¸°</button>
                    </div>
                    <div style="background: #fff3cd; padding: 20px; border-radius: 12px; margin: 20px 0; border-left: 4px solid #ffc107;">
                        <p style="margin: 0 0 15px 0; color: #856404; font-size: 16px; font-weight: bold;">âš ï¸ iOS ì €ì¥ ì•ˆë‚´:</p>
                        <p style="margin: 0 0 10px 0; color: #856404; font-size: 14px; line-height: 1.5;">
                            <strong>ìœ„ ë²„íŠ¼ì´ ì‘ë™í•˜ì§€ ì•Šìœ¼ë©´:</strong><br>
                            1ï¸âƒ£ ì´ë¯¸ì§€ë¥¼ <strong>ê¸¸ê²Œ ëˆ„ë¥´ì„¸ìš”</strong><br>
                            2ï¸âƒ£ "ì´ë¯¸ì§€ ì €ì¥" ë˜ëŠ” "ì‚¬ì§„ì— ì €ì¥" ì„ íƒ<br>
                            3ï¸âƒ£ ë˜ëŠ” "ê³µìœ " ë²„íŠ¼ìœ¼ë¡œ ê°¤ëŸ¬ë¦¬ì— ì €ì¥
                        </p>
                    </div>
                    <button onclick="this.parentElement.parentElement.remove()" style="
                        padding: 12px 24px;
                        background: #667eea;
                        color: white;
                        border: none;
                        border-radius: 8px;
                        font-size: 14px;
                        cursor: pointer;
                    ">ë‹«ê¸°</button>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            });
        }
        
        // ì§ì ‘ ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ í•¨ìˆ˜ (ì „ì—­ì—ì„œ ì ‘ê·¼ ê°€ëŠ¥í•˜ë„ë¡)
        window.downloadImageDirectly = function(dataURL, fileName) {
            console.log('ì§ì ‘ ë‹¤ìš´ë¡œë“œ ì‹œë„:', fileName);
            
            const link = document.createElement('a');
            link.href = dataURL;
            link.download = fileName;
            link.style.display = 'none';
            document.body.appendChild(link);
            
            try {
                link.click();
                console.log('ë‹¤ìš´ë¡œë“œ ë§í¬ í´ë¦­ ì™„ë£Œ');
                
                // iOSì—ì„œëŠ” ì‹¤ì œ ì €ì¥ ì—¬ë¶€ë¥¼ í™•ì¸í•  ìˆ˜ ì—†ìœ¼ë¯€ë¡œ ì•ˆë‚´ ë©”ì‹œì§€ë§Œ í‘œì‹œ
                setTimeout(() => {
                    showIOSDownloadCompleteModal();
                }, 500);
            } catch (error) {
                console.error('ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨:', error);
                showSaveErrorModal();
            }
            
            document.body.removeChild(link);
        };
        
        // iOS ë‹¤ìš´ë¡œë“œ ì™„ë£Œ ì•ˆë‚´ ëª¨ë‹¬
        function showIOSDownloadCompleteModal() {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.8);
                z-index: 10000;
                display: flex;
                justify-content: center;
                align-items: center;
                padding: 20px;
                box-sizing: border-box;
            `;
            
            modal.innerHTML = `
                <div style="
                    background: white;
                    border-radius: 15px;
                    padding: 30px;
                    max-width: 90%;
                    text-align: center;
                ">
                    <div style="font-size: 48px; margin-bottom: 20px;">ğŸ“±</div>
                    <h3 style="margin: 0 0 20px 0; color: #333; font-size: 18px;">ë‹¤ìš´ë¡œë“œ ì‹œë„ ì™„ë£Œ</h3>
                    <p style="margin: 0 0 20px 0; color: #666; font-size: 14px; line-height: 1.5;">
                        ë‹¤ìš´ë¡œë“œë¥¼ ì‹œë„í–ˆìŠµë‹ˆë‹¤.<br>
                        <strong>ë§Œì•½ ì €ì¥ì´ ì•ˆ ë˜ì—ˆë‹¤ë©´</strong> ì´ë¯¸ì§€ë¥¼ ê¸¸ê²Œ ëˆŒëŸ¬ì„œ "ì´ë¯¸ì§€ ì €ì¥"ì„ ì„ íƒí•´ì£¼ì„¸ìš”.
                    </p>
                    <button onclick="this.parentElement.parentElement.remove()" style="
                        padding: 12px 24px;
                        background: #667eea;
                        color: white;
                        border: none;
                        border-radius: 8px;
                        font-size: 14px;
                        cursor: pointer;
                    ">í™•ì¸</button>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            });
        }
        
        // Android Chrome ê°¤ëŸ¬ë¦¬ ì €ì¥
        function saveToGalleryAndroid(blob, fileName) {
            // Androidì—ì„œëŠ” File System Access API ì‹œë„
            if ('showSaveFilePicker' in window) {
                const file = new File([blob], fileName, { type: 'image/jpeg' });
                window.showSaveFilePicker({
                    suggestedName: fileName,
                    types: [{
                        description: 'JPEG images',
                        accept: { 'image/jpeg': ['.jpg'] }
                    }]
                }).then(fileHandle => {
                    return fileHandle.createWritable();
                }).then(writable => {
                    return writable.write(file);
                }).then(() => {
                    showSaveSuccessModal();
                }).catch(error => {
                    console.log('File System Access API ì‹¤íŒ¨:', error);
                    saveToGalleryGeneric(blob, fileName);
                });
            } else {
                saveToGalleryGeneric(blob, fileName);
            }
        }
        
        // ì¼ë°˜ ëª¨ë°”ì¼ ë¸Œë¼ìš°ì € ê°¤ëŸ¬ë¦¬ ì €ì¥
        function saveToGalleryGeneric(blob, fileName) {
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = fileName;
            link.style.display = 'none';
            document.body.appendChild(link);
            
            try {
                link.click();
                // ì¼ë°˜ ë¸Œë¼ìš°ì €ì—ì„œëŠ” ì„±ê³µ ëª¨ë‹¬ í‘œì‹œ
                setTimeout(() => {
                    showSaveSuccessModal();
                }, 500);
            } catch (error) {
                console.log('ì¼ë°˜ ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨:', error);
                showSaveModal(url, fileName);
            }
            
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }
        
        // ì €ì¥ ì„±ê³µ ëª¨ë‹¬
        function showSaveSuccessModal() {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.8);
                z-index: 10000;
                display: flex;
                justify-content: center;
                align-items: center;
                padding: 20px;
                box-sizing: border-box;
            `;
            
            modal.innerHTML = `
                <div style="
                    background: white;
                    border-radius: 15px;
                    padding: 30px;
                    max-width: 90%;
                    text-align: center;
                ">
                    <div style="font-size: 48px; margin-bottom: 20px;">âœ…</div>
                    <h3 style="margin: 0 0 20px 0; color: #333; font-size: 18px;">ê°¤ëŸ¬ë¦¬ì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!</h3>
                    <p style="margin: 0 0 20px 0; color: #666; font-size: 14px;">
                        ì´ë¯¸ì§€ê°€ ê°¤ëŸ¬ë¦¬ì— ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤
                    </p>
                    <button onclick="this.parentElement.parentElement.remove()" style="
                        padding: 12px 24px;
                        background: #667eea;
                        color: white;
                        border: none;
                        border-radius: 8px;
                        font-size: 14px;
                        cursor: pointer;
                    ">í™•ì¸</button>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // 3ì´ˆ í›„ ìë™ ë‹«ê¸°
            setTimeout(() => {
                if (modal.parentNode) {
                    modal.remove();
                }
            }, 3000);
        }
        
        // ì €ì¥ ëª¨ë‹¬ (ëŒ€ì•ˆ ë°©ë²•)
        function showSaveModal(dataURL, fileName) {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.8);
                z-index: 10000;
                display: flex;
                justify-content: center;
                align-items: center;
                padding: 20px;
                box-sizing: border-box;
            `;
            
            modal.innerHTML = `
                <div style="
                    background: white;
                    border-radius: 15px;
                    padding: 30px;
                    max-width: 90%;
                    max-height: 90%;
                    text-align: center;
                    overflow-y: auto;
                ">
                    <h3 style="margin: 0 0 20px 0; color: #333; font-size: 18px;">ì´ë¯¸ì§€ê°€ ì¤€ë¹„ë˜ì—ˆìŠµë‹ˆë‹¤</h3>
                    <img src="${dataURL}" style="
                        max-width: 100%;
                        height: auto;
                        border: 2px solid #667eea;
                        border-radius: 10px;
                        margin-bottom: 20px;
                    ">
                    <p style="margin: 0 0 20px 0; color: #666; font-size: 14px;">
                        ì´ë¯¸ì§€ë¥¼ ê¸¸ê²Œ ëˆŒëŸ¬ "ì´ë¯¸ì§€ ì €ì¥" ë˜ëŠ” "ì‚¬ì§„ì— ì €ì¥"ì„ ì„ íƒí•˜ì„¸ìš”
                    </p>
                    <div style="display: flex; gap: 10px; justify-content: center;">
                        <button onclick="this.parentElement.parentElement.parentElement.remove()" style="
                            padding: 12px 24px;
                            background: #667eea;
                            color: white;
                            border: none;
                            border-radius: 8px;
                            font-size: 14px;
                            cursor: pointer;
                        ">ë‹«ê¸°</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            });
        }
        
        // ì €ì¥ ì˜¤ë¥˜ ëª¨ë‹¬
        function showSaveErrorModal() {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.8);
                z-index: 10000;
                display: flex;
                justify-content: center;
                align-items: center;
                padding: 20px;
                box-sizing: border-box;
            `;
            
            modal.innerHTML = `
                <div style="
                    background: white;
                    border-radius: 15px;
                    padding: 30px;
                    max-width: 90%;
                    text-align: center;
                ">
                    <div style="font-size: 48px; margin-bottom: 20px;">âŒ</div>
                    <h3 style="margin: 0 0 20px 0; color: #333; font-size: 18px;">ì €ì¥ ì‹¤íŒ¨</h3>
                    <p style="margin: 0 0 20px 0; color: #666; font-size: 14px;">
                        ì´ë¯¸ì§€ ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.
                    </p>
                    <button onclick="this.parentElement.parentElement.remove()" style="
                        padding: 12px 24px;
                        background: #667eea;
                        color: white;
                        border: none;
                        border-radius: 8px;
                        font-size: 14px;
                        cursor: pointer;
                    ">í™•ì¸</button>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        // ìµœì¢… ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ (ìƒˆë¡œìš´ ì‹œìŠ¤í…œ ì‚¬ìš©)
        function downloadFinalImage() {
            compositeSystem.downloadImage();
        }
        
        // í¸ì§‘ í•¸ë“¤ ë””ë²„ê¹… í•¨ìˆ˜ (ê°œë°œì ì½˜ì†”ì—ì„œ ì‚¬ìš©) - ë¹„í™œì„±í™”
        window.debugEditHandles = function(enable = false) {
            window.debugEditHandles = enable;
            if (enable) {
                console.log('í¸ì§‘ í•¸ë“¤ ë””ë²„ê¹… í™œì„±í™”ë¨');
                syncEditHandlesWithContent();
            } else {
                console.log('í¸ì§‘ í•¸ë“¤ ë””ë²„ê¹… ë¹„í™œì„±í™”ë¨');
                const debugDiv = document.getElementById('debugEditHandles');
                if (debugDiv) {
                    debugDiv.remove();
                }
            }
        };
        
        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        backgroundInput.addEventListener('change', async (e) => {
            console.log('ë°°ê²½ ì´ë¯¸ì§€ ì—…ë¡œë“œ ì‹œì‘');
            const file = e.target.files[0];
            if (file) {
                console.log('íŒŒì¼ ì„ íƒë¨:', file.name);
                try {
                    const compressed = await compressImage(file);
                    backgroundImage = URL.createObjectURL(compressed);
                    
                    // ì—…ë¡œë“œ ì˜ì—­ì„ ì²´í¬ ì•„ì´ì½˜ìœ¼ë¡œ êµì²´
                    const uploadArea = document.getElementById('backgroundUploadArea');
                    const checkArea = document.getElementById('backgroundCheckArea');
                    uploadArea.style.display = 'none';
                    checkArea.style.display = 'block';
                    
                    // ë‹¤ìŒ ë‹¨ê³„ ë²„íŠ¼ í‘œì‹œ
                    document.getElementById('nextButtonContainer').style.display = 'block';
                    
                    console.log('ë°°ê²½ ì´ë¯¸ì§€ ì—…ë¡œë“œ ì™„ë£Œ');
                } catch (error) {
                    console.error('ë°°ê²½ ì´ë¯¸ì§€ ì²˜ë¦¬ ì˜¤ë¥˜:', error);
                }
            }
        });
        
        calligraphyInput.addEventListener('change', async (e) => {
            console.log('ê¸€ì”¨ ì´ë¯¸ì§€ ì—…ë¡œë“œ ì‹œì‘');
            const file = e.target.files[0];
            if (file) {
                console.log('ê¸€ì”¨ íŒŒì¼ ì„ íƒë¨:', file.name);
                
                try {
                    const compressed = await compressImage(file);
                    calligraphyImage = URL.createObjectURL(compressed);
                    
                    // ì ì„  ì˜ì—­ì„ ì‚¬ì§„ìœ¼ë¡œ êµì²´
                    const uploadArea = calligraphyInput.closest('.file-upload-area');
                    if (uploadArea) {
                    uploadArea.style.display = 'none';
                    }
                    
                    console.log('ê¸€ì”¨ ì´ë¯¸ì§€ ì—…ë¡œë“œ ì™„ë£Œ, ìë™ìœ¼ë¡œ ë‹¤ìŒ ë‹¨ê³„ë¡œ ì´ë™');
                    // ìë™ìœ¼ë¡œ ë‹¤ìŒ ë‹¨ê³„ë¡œ ì´ë™
                    setTimeout(async () => {
                        // ê¸€ì”¨ ì´ë¯¸ì§€ ìë™ ë³´ì • ì²˜ë¦¬
                        if (calligraphyImage) {
                            try {
                    const processed = await processCalligraphyImage(calligraphyImage);
                    processedCalligraphy = URL.createObjectURL(processed);
                    processedCalligraphyEl.src = processedCalligraphy;
                    
                    // ìƒˆë¡œìš´ í¬ë¡­ ì‹œìŠ¤í…œ ì´ˆê¸°í™”
                    setTimeout(() => {
                        initCropArea();
                        setupCropEvents();
                    }, 100);
                            } catch (error) {
                                console.error('ê¸€ì”¨ ì´ë¯¸ì§€ ì²˜ë¦¬ ì˜¤ë¥˜:', error);
                            }
                        }
                        nextStep();
                    }, 500); // 0.5ì´ˆ í›„ ìë™ ì´ë™
                } catch (error) {
                    console.error('ê¸€ì”¨ ì´ë¯¸ì§€ ì²˜ë¦¬ ì˜¤ë¥˜:', error);
                }
            }
        });
        
        
        // í¬ë¡­ í•¸ë“¤ ë“œë˜ê·¸ ì´ë²¤íŠ¸
        let isResizing = false;
        let isMoving = false;
        let resizeDirection = '';
        let startMousePos = { x: 0, y: 0 };
        let startCropArea = { x: 0, y: 0, width: 100, height: 100 };
        
        // í¬ë¡­ ì˜ì—­ ì´ˆê¸°í™” (ìƒˆë¡œìš´ ì‹œìŠ¤í…œ ì‚¬ìš©)
        function initCropArea() {
            cropSystem.cropArea = { x: 10, y: 10, width: 80, height: 80 };
            
            // ì´ë¯¸ì§€ê°€ ë¡œë“œëœ í›„ í¬ë¡­ í•¸ë“¤ ì—…ë°ì´íŠ¸
            setTimeout(() => {
                const cropAreaEl = document.getElementById('cropArea');
                if (cropAreaEl) {
                    cropSystem.updateCropHandles(cropAreaEl);
                }
            }, 100);
        }
        
        // í¬ë¡­ í•¸ë“¤ ì—…ë°ì´íŠ¸ (ìƒˆë¡œìš´ ì‹œìŠ¤í…œ ì‚¬ìš©)
        function updateCropHandles() {
            const cropAreaEl = document.getElementById('cropArea');
            if (cropAreaEl) {
                cropSystem.updateCropHandles(cropAreaEl);
            }
        }
        
        // ìƒˆë¡œìš´ ì •í™•í•œ í¬ë¡­ ì´ë²¤íŠ¸ ì‹œìŠ¤í…œ
        function setupCropEvents() {
            const img = document.getElementById('processedCalligraphy');
            const cropAreaEl = document.getElementById('cropArea');
            
            if (!img || !cropAreaEl) {
                console.log('í¬ë¡­ ì´ë²¤íŠ¸ ì„¤ì • ì‹¤íŒ¨: ì´ë¯¸ì§€ ë˜ëŠ” í¬ë¡­ ì˜ì—­ ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ');
                return;
            }
            
            console.log('í¬ë¡­ ì´ë²¤íŠ¸ ì„¤ì • ì™„ë£Œ');
            
            // í¬ë¡­ í•¸ë“¤ ì´ë²¤íŠ¸ëŠ” updateHandlesì—ì„œ ì„¤ì •ë¨
            
            // í¬ë¡­ ì˜ì—­ ë“œë˜ê·¸ ì´ë²¤íŠ¸ (ë§ˆìš°ìŠ¤ + í„°ì¹˜)
            cropAreaEl.addEventListener('mousedown', (e) => {
                // í•¸ë“¤ì„ í´ë¦­í•œ ê²½ìš° ë“œë˜ê·¸ ì‹œì‘í•˜ì§€ ì•ŠìŒ
                if (e.target.classList.contains('crop-handle')) {
                    console.log('í•¸ë“¤ í´ë¦­ ê°ì§€ - ë“œë˜ê·¸ ì‹œì‘í•˜ì§€ ì•ŠìŒ');
                    return;
                }
                
                console.log('í¬ë¡­ ì˜ì—­ ë“œë˜ê·¸ ì‹œì‘');
                cropSystem.isDragging = true;
                cropSystem.startPos = { x: e.clientX, y: e.clientY };
                cropSystem.startCropArea = { ...cropSystem.cropArea };
                e.preventDefault();
                e.stopPropagation();
            });

            cropAreaEl.addEventListener('touchstart', (e) => {
                // í•¸ë“¤ì„ í´ë¦­í•œ ê²½ìš° ë“œë˜ê·¸ ì‹œì‘í•˜ì§€ ì•ŠìŒ
                if (e.target.classList.contains('crop-handle')) {
                    console.log('í•¸ë“¤ í´ë¦­ ê°ì§€ - ë“œë˜ê·¸ ì‹œì‘í•˜ì§€ ì•ŠìŒ');
                    return;
                }
                
                console.log('í¬ë¡­ ì˜ì—­ í„°ì¹˜ ë“œë˜ê·¸ ì‹œì‘');
                cropSystem.isDragging = true;
                const touch = e.touches[0];
                // í„°ì¹˜ ì¢Œí‘œë¥¼ ë” ì •í™•í•˜ê²Œ ì €ì¥
                cropSystem.startPos = { 
                    x: touch.clientX, 
                    y: touch.clientY,
                    pageX: touch.pageX,
                    pageY: touch.pageY
                };
                cropSystem.startCropArea = { ...cropSystem.cropArea };
                // ëª¨ë°”ì¼ ìµœì í™”: ì¦‰ì‹œ ë“œë˜ê·¸ í—ˆìš©
                cropSystem.minMoveDistance = 0; // ëª¨ë°”ì¼ì—ì„œëŠ” ì¦‰ì‹œ ë°˜ì‘
                cropSystem.hasMoved = true; // ì´ë¯¸ ì›€ì§ì¸ ê²ƒìœ¼ë¡œ ê°„ì£¼
                e.preventDefault();
                e.stopPropagation();
            });
            
            // ë§ˆìš°ìŠ¤ ì´ë™ ì´ë²¤íŠ¸
            document.addEventListener('mousemove', (e) => {
                if (cropSystem.isResizing) {
                    const displayBounds = cropSystem.getImageDisplayBounds(img);
                    const deltaX = ((e.clientX - cropSystem.startPos.x) / displayBounds.width) * 100;
                    const deltaY = ((e.clientY - cropSystem.startPos.y) / displayBounds.height) * 100;
                    
                    console.log('í¬ë¡­ ë¦¬ì‚¬ì´ì§•:', {
                        direction: cropSystem.resizeHandle,
                        deltaX, deltaY,
                        startPos: cropSystem.startPos,
                        currentPos: { x: e.clientX, y: e.clientY }
                    });
                    
                    let newCropArea = { ...cropSystem.startCropArea };
                    
                    // ë¦¬ì‚¬ì´ì§• ë°©í–¥ì— ë”°ë¥¸ ì²˜ë¦¬
                    switch(cropSystem.resizeHandle) {
                        case 'nw': // ì™¼ìª½ ìœ„
                            newCropArea.x = Math.max(0, cropSystem.startCropArea.x + deltaX);
                            newCropArea.y = Math.max(0, cropSystem.startCropArea.y + deltaY);
                            newCropArea.width = Math.max(5, cropSystem.startCropArea.width - deltaX);
                            newCropArea.height = Math.max(5, cropSystem.startCropArea.height - deltaY);
                            break;
                        case 'ne': // ì˜¤ë¥¸ìª½ ìœ„
                            newCropArea.y = Math.max(0, cropSystem.startCropArea.y + deltaY);
                            newCropArea.width = Math.max(5, cropSystem.startCropArea.width + deltaX);
                            newCropArea.height = Math.max(5, cropSystem.startCropArea.height - deltaY);
                            break;
                        case 'sw': // ì™¼ìª½ ì•„ë˜
                            newCropArea.x = Math.max(0, cropSystem.startCropArea.x + deltaX);
                            newCropArea.width = Math.max(5, cropSystem.startCropArea.width - deltaX);
                            newCropArea.height = Math.max(5, cropSystem.startCropArea.height + deltaY);
                            break;
                        case 'se': // ì˜¤ë¥¸ìª½ ì•„ë˜
                            newCropArea.width = Math.max(5, cropSystem.startCropArea.width + deltaX);
                            newCropArea.height = Math.max(5, cropSystem.startCropArea.height + deltaY);
                            break;
                        case 'n': // ìœ„
                            newCropArea.y = Math.max(0, cropSystem.startCropArea.y + deltaY);
                            newCropArea.height = Math.max(5, cropSystem.startCropArea.height - deltaY);
                            break;
                        case 's': // ì•„ë˜
                            newCropArea.height = Math.max(5, cropSystem.startCropArea.height + deltaY);
                            break;
                        case 'w': // ì™¼ìª½
                            newCropArea.x = Math.max(0, cropSystem.startCropArea.x + deltaX);
                            newCropArea.width = Math.max(5, cropSystem.startCropArea.width - deltaX);
                            break;
                        case 'e': // ì˜¤ë¥¸ìª½
                            newCropArea.width = Math.max(5, cropSystem.startCropArea.width + deltaX);
                            break;
                    }
                    
                    // ê²½ê³„ ì²´í¬
                    if (newCropArea.x + newCropArea.width > 100) {
                        newCropArea.width = 100 - newCropArea.x;
                    }
                    if (newCropArea.y + newCropArea.height > 100) {
                        newCropArea.height = 100 - newCropArea.y;
                    }
                    
                    cropSystem.cropArea = newCropArea;
                    cropSystem.updateCropHandles();
                } else if (cropSystem.isDragging) {
                    const displayBounds = cropSystem.getImageDisplayBounds(img);
                    const deltaX = ((e.clientX - cropSystem.startPos.x) / displayBounds.width) * 100;
                    const deltaY = ((e.clientY - cropSystem.startPos.y) / displayBounds.height) * 100;
                    
                    let newCropArea = { ...cropSystem.startCropArea };
                    newCropArea.x = Math.max(0, Math.min(100 - newCropArea.width, cropSystem.startCropArea.x + deltaX));
                    newCropArea.y = Math.max(0, Math.min(100 - newCropArea.height, cropSystem.startCropArea.y + deltaY));
                    
                    cropSystem.cropArea = newCropArea;
                    cropSystem.updateCropHandles();
                }
            });

            // í„°ì¹˜ ì´ë™ ì´ë²¤íŠ¸ (ìµœì í™” ë° ê°ë„ ê°œì„ )
            document.addEventListener('touchmove', (e) => {
                if (cropSystem.isResizing || cropSystem.isDragging) {
                    e.preventDefault(); // í„°ì¹˜ ìŠ¤í¬ë¡¤ ë°©ì§€
                    e.stopPropagation();
                    
                    if (cropSystem.isResizing) {
                        const displayBounds = cropSystem.getImageDisplayBounds(img);
                        const touch = e.touches[0];
                        
                        // ëª¨ë°”ì¼ì—ì„œëŠ” ì¦‰ì‹œ ì›€ì§ì„ í—ˆìš© (hasMovedê°€ ì´ë¯¸ trueë¡œ ì„¤ì •ë¨)
                        if (!cropSystem.hasMoved) {
                            cropSystem.hasMoved = true;
                            console.log('ë¦¬ì‚¬ì´ì§• ì‹œì‘');
                        }
                        
                        // í„°ì¹˜ ê°ë„ ê°œì„ : ìì—°ìŠ¤ëŸ¬ìš´ ë°˜ì‘
                        const sensitivity = 1.5; // ê°ë„ ì¡°ì • (ìì—°ìŠ¤ëŸ¬ìš´ ì›€ì§ì„)
                        const deltaX = ((touch.clientX - cropSystem.startPos.x) / displayBounds.width) * 100 * sensitivity;
                        const deltaY = ((touch.clientY - cropSystem.startPos.y) / displayBounds.height) * 100 * sensitivity;
                        
                        let newCropArea = { ...cropSystem.startCropArea };
                        
                        // ë¦¬ì‚¬ì´ì§• ë°©í–¥ì— ë”°ë¥¸ ì²˜ë¦¬
                        switch(cropSystem.resizeHandle) {
                            case 'nw': // ì™¼ìª½ ìœ„
                                newCropArea.x = Math.max(0, cropSystem.startCropArea.x + deltaX);
                                newCropArea.y = Math.max(0, cropSystem.startCropArea.y + deltaY);
                                newCropArea.width = Math.max(5, cropSystem.startCropArea.width - deltaX);
                                newCropArea.height = Math.max(5, cropSystem.startCropArea.height - deltaY);
                                break;
                            case 'ne': // ì˜¤ë¥¸ìª½ ìœ„
                                newCropArea.y = Math.max(0, cropSystem.startCropArea.y + deltaY);
                                newCropArea.width = Math.max(5, cropSystem.startCropArea.width + deltaX);
                                newCropArea.height = Math.max(5, cropSystem.startCropArea.height - deltaY);
                                break;
                            case 'sw': // ì™¼ìª½ ì•„ë˜
                                newCropArea.x = Math.max(0, cropSystem.startCropArea.x + deltaX);
                                newCropArea.width = Math.max(5, cropSystem.startCropArea.width - deltaX);
                                newCropArea.height = Math.max(5, cropSystem.startCropArea.height + deltaY);
                                break;
                            case 'se': // ì˜¤ë¥¸ìª½ ì•„ë˜
                                newCropArea.width = Math.max(5, cropSystem.startCropArea.width + deltaX);
                                newCropArea.height = Math.max(5, cropSystem.startCropArea.height + deltaY);
                                break;
                            case 'n': // ìœ„
                                newCropArea.y = Math.max(0, cropSystem.startCropArea.y + deltaY);
                                newCropArea.height = Math.max(5, cropSystem.startCropArea.height - deltaY);
                                break;
                            case 's': // ì•„ë˜
                                newCropArea.height = Math.max(5, cropSystem.startCropArea.height + deltaY);
                                break;
                            case 'w': // ì™¼ìª½
                                newCropArea.x = Math.max(0, cropSystem.startCropArea.x + deltaX);
                                newCropArea.width = Math.max(5, cropSystem.startCropArea.width - deltaX);
                                break;
                            case 'e': // ì˜¤ë¥¸ìª½
                                newCropArea.width = Math.max(5, cropSystem.startCropArea.width + deltaX);
                                break;
                        }
                        
                        // ê²½ê³„ ì²´í¬
                        if (newCropArea.x + newCropArea.width > 100) {
                            newCropArea.width = 100 - newCropArea.x;
                        }
                        if (newCropArea.y + newCropArea.height > 100) {
                            newCropArea.height = 100 - newCropArea.y;
                        }
                        
                        cropSystem.cropArea = newCropArea;
                        
                        // ë””ë°”ìš´ì‹±ì„ ìœ„í•œ setTimeout ì‚¬ìš© (ì¦‰ì‹œ ì—…ë°ì´íŠ¸)
                        if (touchUpdateTimeout) {
                            clearTimeout(touchUpdateTimeout);
                        }
                        touchUpdateTimeout = setTimeout(() => {
                            cropSystem.updateCropHandles();
                        }, 50); // 50ms ë””ë°”ìš´ì‹±ìœ¼ë¡œ ì•ˆì •ì„± í–¥ìƒ
                    } else if (cropSystem.isDragging) {
                        const displayBounds = cropSystem.getImageDisplayBounds(img);
                        const touch = e.touches[0];
                        
                        // ëª¨ë°”ì¼ì—ì„œëŠ” ì¦‰ì‹œ ì›€ì§ì„ í—ˆìš© (hasMovedê°€ ì´ë¯¸ trueë¡œ ì„¤ì •ë¨)
                        if (!cropSystem.hasMoved) {
                            cropSystem.hasMoved = true;
                            console.log('ë“œë˜ê·¸ ì‹œì‘');
                        }
                        
                        // ë“œë˜ê¹… ê°ë„ë„ ê°œì„  (ìì—°ìŠ¤ëŸ¬ìš´ ë°˜ì‘)
                        const sensitivity = 1.5; // ê°ë„ ì¡°ì • (ìì—°ìŠ¤ëŸ¬ìš´ ì›€ì§ì„)
                        const deltaX = ((touch.clientX - cropSystem.startPos.x) / displayBounds.width) * 100 * sensitivity;
                        const deltaY = ((touch.clientY - cropSystem.startPos.y) / displayBounds.height) * 100 * sensitivity;
                        
                        let newCropArea = { ...cropSystem.startCropArea };
                        newCropArea.x = Math.max(0, Math.min(100 - newCropArea.width, cropSystem.startCropArea.x + deltaX));
                        newCropArea.y = Math.max(0, Math.min(100 - newCropArea.height, cropSystem.startCropArea.y + deltaY));
                        
                        cropSystem.cropArea = newCropArea;
                        
                        // ë””ë°”ìš´ì‹±ì„ ìœ„í•œ setTimeout ì‚¬ìš© (ì¦‰ì‹œ ì—…ë°ì´íŠ¸)
                        if (touchUpdateTimeout) {
                            clearTimeout(touchUpdateTimeout);
                        }
                        touchUpdateTimeout = setTimeout(() => {
                            cropSystem.updateCropHandles();
                        }, 50); // 50ms ë””ë°”ìš´ì‹±ìœ¼ë¡œ ì•ˆì •ì„± í–¥ìƒ
                    }
                }
            }, { passive: false }); // passive: falseë¡œ ì„¤ì •í•˜ì—¬ preventDefault ê°€ëŠ¥
            
            // ë§ˆìš°ìŠ¤ ì—… ì´ë²¤íŠ¸
            document.addEventListener('mouseup', () => {
                // ë¦¬ì‚¬ì´ì§• ë˜ëŠ” ë“œë˜ê¹… ìƒíƒœì˜€ëŠ”ì§€ í™•ì¸
                const wasResizing = cropSystem.isResizing;
                const wasDragging = cropSystem.isDragging;
                
                cropSystem.isResizing = false;
                cropSystem.isDragging = false;
                cropSystem.hasMoved = false; // ìƒíƒœ ì™„ì „ ë¦¬ì…‹
                cropSystem.minMoveDistance = 0; // ìµœì†Œ ì´ë™ ê±°ë¦¬ ë¦¬ì…‹
                
                // ë§ˆìš°ìŠ¤ ì¢…ë£Œ ì‹œì ì—ì„œ í¬ë¡­ í•¸ë“¤ ì¦‰ì‹œ ì—…ë°ì´íŠ¸
                if (wasResizing || wasDragging) {
                    setTimeout(() => {
                        cropSystem.updateCropHandles();
                        console.log('ë§ˆìš°ìŠ¤ ì¢…ë£Œ í›„ í¬ë¡­ í•¸ë“¤ ì—…ë°ì´íŠ¸ ì™„ë£Œ');
                    }, 10);
                }
            });

            // í„°ì¹˜ ì¢…ë£Œ ì´ë²¤íŠ¸
            document.addEventListener('touchend', (e) => {
                // ë¦¬ì‚¬ì´ì§• ë˜ëŠ” ë“œë˜ê¹… ìƒíƒœì˜€ëŠ”ì§€ í™•ì¸
                const wasResizing = cropSystem.isResizing;
                const wasDragging = cropSystem.isDragging;
                
                // ìƒíƒœ ì™„ì „ ë¦¬ì…‹
                cropSystem.isResizing = false;
                cropSystem.isDragging = false;
                cropSystem.hasMoved = false;
                cropSystem.minMoveDistance = 0;
                cropSystem.startPos = null;
                cropSystem.startCropArea = null;
                
                // ë””ë°”ìš´ì‹± íƒ€ì´ë¨¸ ì •ë¦¬
                if (touchUpdateTimeout) {
                    clearTimeout(touchUpdateTimeout);
                    touchUpdateTimeout = null;
                }
                
                // í„°ì¹˜ ì¢…ë£Œ ì‹œì ì—ì„œ í¬ë¡­ í•¸ë“¤ ì¦‰ì‹œ ì—…ë°ì´íŠ¸
                if (wasResizing || wasDragging) {
                    // ì¦‰ì‹œ ì—…ë°ì´íŠ¸ (ì§€ì—° ì—†ìŒ)
                    cropSystem.updateCropHandles();
                    console.log('í„°ì¹˜ ì¢…ë£Œ í›„ í¬ë¡­ í•¸ë“¤ ì—…ë°ì´íŠ¸ ì™„ë£Œ');
                }
                
                // í„°ì¹˜ ì´ë²¤íŠ¸ ì „íŒŒ ë°©ì§€
                e.preventDefault();
                e.stopPropagation();
            }, { passive: false });
        }
        
        // í¸ì§‘ í•¸ë“¤ ë³€ìˆ˜
        let isEditing = false;
        let editType = '';
        let editStart = { x: 0, y: 0, scale: 1, rotation: 0 };
        
        // ìƒˆë¡œìš´ í•©ì„± ë¯¸ë¦¬ë³´ê¸° ë“œë˜ê·¸ ì´ë²¤íŠ¸ (ë§ˆìš°ìŠ¤ + í„°ì¹˜)
        calligraphyOverlay.addEventListener('mousedown', (e) => {
            // í¸ì§‘ í•¸ë“¤ì´ ì•„ë‹Œ ê²½ìš°ì—ë§Œ ìœ„ì¹˜ ì´ë™
            if (!e.target.classList.contains('edit-handle')) {
                isDragging = true;
                const rect = compositePreview.getBoundingClientRect();
                dragStart = {
                    x: e.clientX - rect.left,
                    y: e.clientY - rect.top
                };
                e.preventDefault();
            }
        });

        // í„°ì¹˜ ì´ë²¤íŠ¸ ì¶”ê°€ (ìµœì í™”)
        calligraphyOverlay.addEventListener('touchstart', (e) => {
            // í¸ì§‘ í•¸ë“¤ì´ ì•„ë‹Œ ê²½ìš°ì—ë§Œ ìœ„ì¹˜ ì´ë™
            if (!e.target.classList.contains('edit-handle')) {
                isDragging = true;
                const rect = compositePreview.getBoundingClientRect();
                const touch = e.touches[0];
                dragStart = {
                    x: touch.clientX - rect.left,
                    y: touch.clientY - rect.top
                };
                e.preventDefault();
                e.stopPropagation();
            }
        }, { passive: false });
        
        // í¬ê¸° ì¡°ì • í•¸ë“¤ (ë§ˆìš°ìŠ¤ + í„°ì¹˜)
        document.getElementById('scaleHandle').addEventListener('mousedown', (e) => {
            isEditing = true;
            editType = 'scale';
            editStart = {
                x: e.clientX,
                y: e.clientY,
                scale: compositeSystem.scale,
                rotation: compositeSystem.rotation
            };
            e.preventDefault();
            e.stopPropagation();
        });

        document.getElementById('scaleHandle').addEventListener('touchstart', (e) => {
            isEditing = true;
            editType = 'scale';
            const touch = e.touches[0];
            editStart = {
                x: touch.clientX,
                y: touch.clientY,
                scale: compositeSystem.scale,
                rotation: compositeSystem.rotation
            };
            e.preventDefault();
            e.stopPropagation();
        }, { passive: false });
        
        // íšŒì „ í•¸ë“¤ (ë§ˆìš°ìŠ¤ + í„°ì¹˜)
        document.getElementById('rotateHandle').addEventListener('mousedown', (e) => {
            isEditing = true;
            editType = 'rotate';
            editStart = {
                x: e.clientX,
                y: e.clientY,
                scale: compositeSystem.scale,
                rotation: compositeSystem.rotation
            };
            e.preventDefault();
            e.stopPropagation();
        });

        document.getElementById('rotateHandle').addEventListener('touchstart', (e) => {
            isEditing = true;
            editType = 'rotate';
            const touch = e.touches[0];
            editStart = {
                x: touch.clientX,
                y: touch.clientY,
                scale: compositeSystem.scale,
                rotation: compositeSystem.rotation
            };
            e.preventDefault();
            e.stopPropagation();
        }, { passive: false });
        
        // ë§ˆìš°ìŠ¤ ì´ë™ ì´ë²¤íŠ¸
        document.addEventListener('mousemove', (e) => {
            if (isDragging) {
                const rect = compositePreview.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;
                
                    const newX = Math.max(0, Math.min(100, ((x / rect.width) * 100)));
                    const newY = Math.max(0, Math.min(100, ((y / rect.height) * 100)));
                    
                    compositeSystem.updatePosition(newX, newY);
                    // ë“œë˜ê·¸ ì¤‘ì—ëŠ” í¸ì§‘ í•¸ë“¤ ë™ê¸°í™” í•˜ì§€ ì•ŠìŒ (ê¹œë¹¡ê±°ë¦¼ ë°©ì§€)
            } else if (isEditing) {
                const deltaX = e.clientX - editStart.x;
                const deltaY = e.clientY - editStart.y;
                
                if (editType === 'scale') {
                    // í¬ê¸° ì¡°ì • (ëŒ€ê°ì„  ë°©í–¥ë§Œ, ê°ë„ ì¡°ì ˆ)
                    const diagonalDistance = (deltaX + deltaY) / Math.sqrt(2); // ëŒ€ê°ì„  ê±°ë¦¬
                    const scaleFactor = 1 + (diagonalDistance / 800); // ê°ë„ ì¡°ì ˆ
                    const newScale = Math.max(0.1, Math.min(2, editStart.scale * scaleFactor));
                    compositeSystem.updateScale(newScale);
                    // í¸ì§‘ ì¤‘ì—ëŠ” í¸ì§‘ í•¸ë“¤ ë™ê¸°í™” í•˜ì§€ ì•ŠìŒ (ê¹œë¹¡ê±°ë¦¼ ë°©ì§€)
                } else if (editType === 'rotate') {
                    // íšŒì „ ì¡°ì • (ì¤‘ì‹¬ì  ê¸°ì¤€, ê°ë„ ì¡°ì ˆ)
                    const centerX = editStart.x;
                    const centerY = editStart.y;
                    const startAngle = Math.atan2(editStart.y - centerY, editStart.x - centerX);
                    const currentAngle = Math.atan2(e.clientY - centerY, e.clientX - centerX);
                    const angleDiff = (currentAngle - startAngle) * (180 / Math.PI);
                    const rotationSensitivity = 0.3; // íšŒì „ ê°ë„ 50%ë¡œ ì¡°ì ˆ
                    const newRotation = editStart.rotation + (angleDiff * rotationSensitivity);
                    compositeSystem.updateRotation(newRotation);
                    // í¸ì§‘ ì¤‘ì—ëŠ” í¸ì§‘ í•¸ë“¤ ë™ê¸°í™” í•˜ì§€ ì•ŠìŒ (ê¹œë¹¡ê±°ë¦¼ ë°©ì§€)
                }
            }
        });

        // í„°ì¹˜ ì´ë™ ì´ë²¤íŠ¸ (ìµœì í™”)
        document.addEventListener('touchmove', (e) => {
            // í„°ì¹˜ ì´ë²¤íŠ¸ê°€ ë“œë˜ê·¸ë‚˜ í¸ì§‘ ì¤‘ì¼ ë•Œë§Œ ì²˜ë¦¬
            if (isDragging || isEditing) {
                e.preventDefault(); // í„°ì¹˜ ìŠ¤í¬ë¡¤ ë°©ì§€
                e.stopPropagation();
                
                if (isDragging) {
                    const rect = compositePreview.getBoundingClientRect();
                    const touch = e.touches[0];
                    const x = touch.clientX - rect.left;
                    const y = touch.clientY - rect.top;
                    
                    // ëª¨ë°”ì¼ í„°ì¹˜ ê°ë„ ê°œì„ 
                    const sensitivity = 1.2; // í„°ì¹˜ ê°ë„ ë°°ìˆ˜
                    const newX = Math.max(0, Math.min(100, ((x / rect.width) * 100 * sensitivity)));
                    const newY = Math.max(0, Math.min(100, ((y / rect.height) * 100 * sensitivity)));
                    
                    // requestAnimationFrameìœ¼ë¡œ ì„±ëŠ¥ ìµœì í™”
                    requestAnimationFrame(() => {
                        compositeSystem.updatePosition(newX, newY);
                    });
                } else if (isEditing) {
                    const touch = e.touches[0];
                    const deltaX = touch.clientX - editStart.x;
                    const deltaY = touch.clientY - editStart.y;
                    
                    if (editType === 'scale') {
                        // í¬ê¸° ì¡°ì • (ëŒ€ê°ì„  ë°©í–¥ë§Œ, ê°ë„ ì¡°ì ˆ)
                        const diagonalDistance = (deltaX + deltaY) / Math.sqrt(2); // ëŒ€ê°ì„  ê±°ë¦¬
                        const scaleFactor = 1 + (diagonalDistance / 800); // ê°ë„ ì¡°ì ˆ
                        const newScale = Math.max(0.1, Math.min(2, editStart.scale * scaleFactor));
                        
                        requestAnimationFrame(() => {
                            compositeSystem.updateScale(newScale);
                        });
                    } else if (editType === 'rotate') {
                        // íšŒì „ ì¡°ì • (ì¤‘ì‹¬ì  ê¸°ì¤€, ê°ë„ ì¡°ì ˆ)
                        const centerX = editStart.x;
                        const centerY = editStart.y;
                        const startAngle = Math.atan2(editStart.y - centerY, editStart.x - centerX);
                        const currentAngle = Math.atan2(touch.clientY - centerY, touch.clientX - centerX);
                        const angleDiff = (currentAngle - startAngle) * (180 / Math.PI);
                        const rotationSensitivity = 0.3; // íšŒì „ ê°ë„ 50%ë¡œ ì¡°ì ˆ
                        const newRotation = editStart.rotation + (angleDiff * rotationSensitivity);
                        
                        requestAnimationFrame(() => {
                            compositeSystem.updateRotation(newRotation);
                        });
                    }
                }
            }
        }, { passive: false }); // passive: falseë¡œ ì„¤ì •í•˜ì—¬ preventDefault ê°€ëŠ¥
        
        document.addEventListener('mouseup', () => {
            isDragging = false;
            isEditing = false;
            // ë“œë˜ê·¸/í¸ì§‘ì´ ëë‚¬ì„ ë•Œ í¸ì§‘ í•¸ë“¤ ë™ê¸°í™”
            if (croppedCalligraphy) {
                setTimeout(() => {
                    syncEditHandlesWithContent();
                }, 100);
            }
        });

        document.addEventListener('touchend', () => {
            isDragging = false;
            isEditing = false;
            // ë“œë˜ê·¸/í¸ì§‘ì´ ëë‚¬ì„ ë•Œ í¸ì§‘ í•¸ë“¤ ë™ê¸°í™”
            if (croppedCalligraphy) {
                setTimeout(() => {
                    syncEditHandlesWithContent();
                }, 100);
            }
        });
        
        // ë¸”ë Œë“œ ëª¨ë“œ ë²„íŠ¼ ì´ë²¤íŠ¸
        multiplyMode.addEventListener('click', () => {
            compositeSystem.updateBlendMode('multiply');
            multiplyMode.classList.add('active');
            screenMode.classList.remove('active');
        });
        
        screenMode.addEventListener('click', () => {
            compositeSystem.updateBlendMode('screen');
            screenMode.classList.add('active');
            multiplyMode.classList.remove('active');
        });
        
        // ëª¨ë°”ì¼ ë·°í¬íŠ¸ ë†’ì´ ë™ì  ê³„ì‚° ë° ì ìš©
        function updateMobileViewportHeight() {
            if (window.innerWidth <= 768) {
                const vh = window.innerHeight * 0.01;
                const dvh = window.innerHeight * 0.01;
                
                // CSS ë³€ìˆ˜ë¡œ ë™ì  ë·°í¬íŠ¸ ë†’ì´ ì„¤ì •
                document.documentElement.style.setProperty('--vh', `${vh}px`);
                document.documentElement.style.setProperty('--dvh', `${dvh}px`);
                
                // ì•ˆì „ ì˜ì—­ ê³ ë ¤í•œ ë†’ì´ ê³„ì‚°
                const safeAreaTop = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--safe-area-inset-top') || '0');
                const safeAreaBottom = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--safe-area-inset-bottom') || '0');
                
                const adjustedHeight = window.innerHeight - safeAreaTop - safeAreaBottom;
                document.documentElement.style.setProperty('--adjusted-vh', `${adjustedHeight}px`);
                
                console.log('ëª¨ë°”ì¼ ë·°í¬íŠ¸ ë†’ì´ ì—…ë°ì´íŠ¸:', {
                    innerHeight: window.innerHeight,
                    vh: vh,
                    safeAreaTop,
                    safeAreaBottom,
                    adjustedHeight
                });
            }
        }
        
        // ì´ˆê¸° ë¡œë“œ ì‹œ ë° ë¦¬ì‚¬ì´ì¦ˆ ì‹œ ë·°í¬íŠ¸ ë†’ì´ ì—…ë°ì´íŠ¸
        updateMobileViewportHeight();
        window.addEventListener('resize', updateMobileViewportHeight);
        window.addEventListener('orientationchange', () => {
            setTimeout(updateMobileViewportHeight, 100);
        });
        
        // ë²„íŠ¼ ì´ë²¤íŠ¸
        document.getElementById('nextToStep2').addEventListener('click', nextStep);
        document.getElementById('nextToStep4').addEventListener('click', async () => {
            // í¬ë¡­ëœ ì´ë¯¸ì§€ ìƒì„±
            if (processedCalligraphy) {
                croppedCalligraphy = await cropSystem.cropImage(processedCalligraphy, cropSystem.cropArea);
                croppedCalligraphy = URL.createObjectURL(croppedCalligraphy);
                
                console.log('í¬ë¡­ëœ ì´ë¯¸ì§€ ìƒì„± ì™„ë£Œ:', croppedCalligraphy);
                
                // í¬ë¡­ ì™„ë£Œ í›„ í•©ì„± ì‹œìŠ¤í…œì˜ ê²½ê³„ ë‹¤ì‹œ ê°ì§€ ë° ë¯¸ë¦¬ë³´ê¸° ì—…ë°ì´íŠ¸
                setTimeout(() => {
                    compositeSystem.detectImageBounds().then(() => {
                        updateCompositePreview();
                        // í¸ì§‘ í•¸ë“¤ ì—…ë°ì´íŠ¸ë¥¼ ë³„ë„ë¡œ í˜¸ì¶œ
                        setTimeout(() => {
                            updateEditHandles();
                        }, 200);
                    });
                }, 100);
            }
            nextStep();
        });
        document.getElementById('downloadBtn').addEventListener('click', downloadFinalImage);
        document.getElementById('restartBtn').addEventListener('click', () => {
            location.reload();
        });
        
        // íŒŒì¼ ë“œë˜ê·¸ ì•¤ ë“œë¡­
        document.querySelectorAll('.file-upload-area').forEach(area => {
            area.addEventListener('dragover', (e) => {
                e.preventDefault();
                area.classList.add('dragover');
            });
            
            area.addEventListener('dragleave', () => {
                area.classList.remove('dragover');
            });
            
            area.addEventListener('drop', async (e) => {
                e.preventDefault();
                area.classList.remove('dragover');
                
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    const file = files[0];
                    if (file.type.startsWith('image/')) {
                        // ë°°ê²½ì‚¬ì§„ ì—…ë¡œë“œ ì˜ì—­ì¸ì§€ í™•ì¸
                        const isBackgroundArea = area.querySelector('#backgroundInput') || 
                                               area.previousElementSibling?.id === 'backgroundInput';
                        
                        if (isBackgroundArea) {
                            backgroundInput.files = files;
                            backgroundInput.dispatchEvent(new Event('change'));
                        } else {
                            calligraphyInput.files = files;
                            calligraphyInput.dispatchEvent(new Event('change'));
                        }
                    }
                }
            });
        });
        
        // í–„ë²„ê±° ë©”ë‰´ ë™ì‘
        const menuBtn = document.getElementById('menu-hamburger');
        const menuPopup = document.getElementById('menu-popup');
        menuBtn.onclick = (e) => {
          e.stopPropagation();
          menuPopup.style.display = (menuPopup.style.display === 'none' || menuPopup.style.display === '') ? 'block' : 'none';
        };
        // ë©”ë‰´ ë°”ê¹¥ í´ë¦­ ì‹œ ë‹«ê¸°
        window.addEventListener('click', (e) => {
          if (menuPopup.style.display === 'block' && !menuPopup.contains(e.target) && e.target !== menuBtn) {
            menuPopup.style.display = 'none';
          }
        });
        
        // ì°½ í¬ê¸° ë³€ê²½ ì‹œ ë°°ê²½ ì´ë¯¸ì§€ ì¬ì¡°ì • ë° í¸ì§‘ í•¸ë“¤ ì—…ë°ì´íŠ¸
        window.addEventListener('resize', () => {
            const compositeBackground = document.getElementById('compositeBackground');
            if (compositeBackground && compositeBackground.src) {
                setTimeout(() => {
                    adjustBackgroundImageSize(compositeBackground);
                    // í¸ì§‘ í•¸ë“¤ë„ í•¨ê»˜ ì—…ë°ì´íŠ¸
                    updateEditHandles();
                    // í¬ë¡­ëœ ì´ë¯¸ì§€ê°€ ìˆìœ¼ë©´ ë‚´ìš© ì˜ì—­ì— ë§ì¶° ì¬ì •ë ¬
                    if (croppedCalligraphy) {
                        setTimeout(() => {
                            syncEditHandlesWithContent();
                        }, 50);
                    }
                }, 100);
            }
        });
        
        // ì´ˆê¸°í™”
        showStep(1);
        
        // ê¸°ì¡´ ë””ë²„ê·¸ ì˜ì—­ ì œê±°
        const existingDebug = document.getElementById('debugEditHandles');
        if (existingDebug) {
            existingDebug.remove();
        }
        
        // í˜ì´ì§€ ë¡œë“œ ì‹œ ë‹¨ê³„ í‘œì‹œ ì´ˆê¸°í™”
        window.addEventListener('load', () => {
            showStep(1);
            // í˜ì´ì§€ ë¡œë“œ ì‹œì—ë„ ë””ë²„ê·¸ ì˜ì—­ ì œê±°
            const debugDiv = document.getElementById('debugEditHandles');
            if (debugDiv) {
                debugDiv.remove();
            }
        });
    </script>
</body>
</html>
